---
editor: 
  markdown: 
    wrap: 80
---

# Assesing uncertanties related to satellite remote sensing indices to estimate Gross Primary Production

## Introduction

Gross Primary Production (GPP) is the total amount of carbon fixation by plants
through photosynthesis [@badgley_terrestrial_2019]. Quantifying GPP is essential
for understanding land-atmosphere carbon exchange [@kohler_global_2018],
ecosystem function, and ecosystem responses to climate change
[@guan_comparison_2022; @brown_fiducial_2021; @myneni_relationship_1994]. With
recent advances in technology for remote sensing and more computational power
available with lower costs [@gorelick_google_2017], global mapping of
photosynthesis is being done by more scientists [@ryu_what_2019]. Given that GPP
cannot be directly estimated from satellite remote sensing techniques, the use
of vegetation indices has been a widely used method to approximate and quantify
GPP [@ryu_what_2019]. However, estimates remain with high uncertainties and
validation efforts are required to characterize these and improve accuracy.
[@anav_spatiotemporal_2015; @brown_fiducial_2021]

There are several methods to calculate GPP that can be grouped into two broad
categories: eddy covariance techniques, and satellite data-driven
[@guan_comparison_2022; @xie_assessments_2020] Eddy Covariance (EC) techniques
are methods that allowed scientists to directly measure the carbon, water, and
energy fluxes between vegetation canopies and the atmosphere since the 1990s
[@baldocchi_how_2020; @ryu_what_2019]. This method to measure terrestrial
fluxes, is the principal approach for quantifying the exchange of CO2 between
the land and atmosphere using advanced field instrumentation
[@badgley_terrestrial_2019; @tramontana_predicting_2016]. Measurements provided
using EC have a limited spatial resolution of less than \< 1km2 , which bring
spatial constraints to estimations of ecosystem carbon and water fluxes at
regional to global scales. [@badgley_canopy_2017].

The second category of methods to estimate GPP is the satellite data-driven
models. Because of their dependency on earth observation platforms, they are not
spatially constrained but can have more uncertainties than the EC techniques
[@ryu_what_2019; @wang_diagnosing_2011]. Satellite data-driven models can be
classified into Vegetation Index models (VI), Light Use Efficiency models (LUE),
and process-based models [@xie_assessments_2020].

LUE models are based on the concept of radiation conversion efficiency, and take
into consideration ecological processes [@liu1997process]. The radiation conversion
efficiency explains the amount of carbon that a specific type of vegetation can
fix per unit of solar radiation [@monteith_solar_1972]. MODIS GPP product uses
an algorithm based on this radiation conversion efficiency concept, relating the
absorbed photosynthetically active radiation (APAR) with the LUE term
[@heinsch_evaluation_2006].

GPP = PAR \* fAPAR \* LUE

Where PAR is the incident photosynthetically active radiation and fAPAR is the
fraction of the PAR that is effectively absorbed by plants. fAPAR can be used to
assess the primary productivity of canopies [GCOS, 2011;
@running_continuous_2004]. LUE is the radiation use conversion efficiency term
of the vegetation [@heinsch_evaluation_2006]

VI's are a summary of satellite obtained spectral data
[@myneni_relationship_1994] derived from optical sensors that are combined with
climate variables to calculate GPP [@wu_predicting_2011]. This is usually done
with some form of regression and physical methods that associate interactions
between vegetation and incoming radiation [@fernandez-martinez_monitoring_2019]

Well known VI's used to estimate GPP are normalized difference vegetation index
(NDVI), enhanced vegetation index (EVI), leaf area index (LAI), and fraction of
photosynthetically active radiation (fPAR) among others
[@balzarolo_influence_2019; @rahman_potential_2005; @rahman_potential_2005;
@xie_assessments_2020; @badgley_terrestrial_2019; @zhang_potential_2020;
@sellers_global_1994]

Nonetheless, even when estimating GPP from satellite remote sensing methods is
promising to overcome limitations as temporal and spatial scale, there are some
challenges involved in the process. The first constraint is the use of images
needed to address the problem of mixed-pixels, which requires determining the
fraction of the vegetated surface and its attributable signal
[@badgley_canopy_2017]. A second challenge is that photosynthesis regulation can
occur with no major changes in canopy structure or leaf pigments that can
undergo without being detected with reflectance data
[@pabon-moreno_potential_2022; @pierrat_diurnal_2022]

The accuracy of GPP estimation through the use of VI's can be affected due to
their limitation to predict spatial, temporal, interannual variability and
trends. [@fernandez-martinez_monitoring_2019]. An index such as NDVI is good for
detecting changes in seasonal variability, but it becomes saturated with high
biomass conditions [@badgley_canopy_2017]. Other indices such as EVI can
overcome this problem and be better suited for predicting GPP in large biomass
forests [@badgley_canopy_2017] but it has been evaluated in a narrow range of
ecosystems and needs inputs of start and end dates of the growing seasons which
can increase uncertainties [@shi_assessing_2017].

To overcome these problems, other indices have been formulated in recent years.
One of these VIs is near-infrared reflectance index (NIRv)
[@badgley_terrestrial_2019] NIRv is defined as the fraction of reflected NIR
light that originates from vegetation. NIRv was originally proposed as a
replacement for fPAR in LUE models in that the NIR and PAR reflectance of
vegetation are correlated and the scaling by NDVI corrects for soil
contributions in the signal [@badgley_terrestrial_2019] NIRv has been shown to have a
stronger correlation to GPP at flux towers and on a regional basis than fAPAR
notwithstanding the fact that GPP is fAPAR driven. NIRv has been extended to
include a weighting with PAR [@dechant_nirvp_2022] and replacing the NIR
reflectance with NIRv radiance [@wu_radiance-based_2020]. Both of these
approaches have been shown to have even stronger correlations with GPP than NIRv
as could be expected since they either directly or indirectly weight the NIRv
with PAR.

The stronger correlation between the NIR indices to GPP versus indices based on
fAPAR seemingly contradicts the hypotheses in the LUE model that GPP should be
linearly related to fAPAR. There are two explanations: i. Many of the reported
comparative studies use fAPAR based on VIs and not APAR. We hypothesize that the
NIR indices are simply better estimators of APAR than these VI approximations
due to lower measurement error for the NIR indices or a stronger physical
relationship between them and APAR versus the historical VIs. The strength of
correlation between APAR and GPP depends on LUE having a linear relationship to
observed APAR. While this may hold in some circumstances (e.g. early seasonal
measurements for vegetation such as crops where leaf chlorophyll concentration
increases during the growth phase) it is not the case in general and definitely
during stress conditions [@monteith_solar_1972].

Despite these efforts, relying solely on these remote satellite indices is a
problem. Efforts to validate and quantify their accuracy are needed
[@brown_fiducial_2021]. In-situ eddy-covariance flux measurements represent a
solution given that they represent site-level observations. With the calculation
of the flux footprint, the area from the flux tower can serve as a reference
point in which satellite images can be linked to a specific set of pixels and
calculate the accuracy of the estimations provided by the indices.
[@chu_representativeness_2021].

As such, the main objective of my M.Sc. thesis is the analysis of uncertainty
associated with the VI/LUE models since they offer the potential for GPP
estimation without requiring knowledge regarding canopy and soil properties
other than measurements of reflected light and possibly a correction for soil
contribution. We aim to quantify the uncertainty from some of the most used
satellite vegetation indices with in-situ GPP data from the Bartlett
Experimental Forest (USA), the Borden Forest Research Station flux-site
(Canada), and the University of Michigan Biological Station (USA).

## Methods

### Eddy Covariance sites

We used three deciduous broad leaf forest sites from the northern hemisphere 
with EC data gathered by Ameriflux. For each site, three datasets were used with 
GPP (`GPP_DT_VUT_REF`) estimated. The ONEFlux processing does the estimation of
the CO2 fluxes into GPP and RECO from NEE through two methods known as daytime
and nighttime. Here we selected the daytime method (DT) which uses daytime and
nighttime to parameterize a model with two components: one based on light
response curve and vapour pressure deficit and a second one using a 
respiration-temperature relationship to estimate RECO which in turn is used to
obtained the difference with NEE and get GPP. [@pastorello2020fluxnet2015]. For
each site, three datasets were used for GPP summarized at daily, weekly, and
monthly time frames. Characteristics of these datasets are in @tbl-oneflux_datasets

The Bartlett experimental forest is located in New Hampshire, USA (44°06′N,
71°3′W). The site has a forest with a canopy mean height around 20-22m and a
mean annual temperature of 6C. Desiptes events such as a hurricane in 1938 and
small scale forest management, the forest mean stand age is around 120-125
years. [@ouimette_carbon_2018]

The second flux site is Borden Forest Research Station located in Ontario
(44°19′N, 79°56′W), Canada. This is one of the largest patches of forest in
Southern Ontario which has been collecting EC data since 1996
[@rogers_response_2020]. This site has a forest cover of over 60% with a height
that exceeds 2 m. It's a deciduous broadleaf natural re-growth forest dominated
by woody vegetation. [@lee_long-term_1999].

The third site is the University of Michigan Biological Station which is located
in northern Michigan, USA (45°350 N 84°430 W). The site have a forest with
different succesional stages and a mean height of 2m. Mean annual temperature is
around 5.5°C. [@gough_disturbanceaccelerated_2021]


-   include description of the oneflux processing (gap filling, data quality,
    gpp estimation, gpp uncertainty with DT and NT)
-   Include plots with trends in appendix for each site of the variables of
  interest

### Satellite imagery

We obtained the data from the collections available in Google Earth Engine, (See
@tbl-satellite_images_datasets) for a defined square polygon with an area of 3km
around the EC tower for each site. For each polygon, the values of all the bands
for every pixel were used.

The MODIS Surface Reflectance products used are `MODIS/006/MOD09GA` (500m
spatial resolution) which consist of 7 reflectance bands from which three of
them were necessary to calculate the vegetation indices (See
@tbl-MODIS_500_indices_bands). The second MODIS product is `MODIS/061/MOD09A1`,
(250m spatial resolution) which consists of two bands, both of them used to
calculate the vegetation indices.

For both data products, we perform a process that was split in three sections:
filtering high quality pixels, scaling band values and vegetation indices
calculation. The filtering of the highest quality pixels can be done with four
bit encoded variables which are: `state_1km`, `qc_500m`, `q_scan`, and
`g_flags`, plus the bands bits that were also indicators of the observation
quality. Bit encoded variables were transformed to strings categories and just
the best quality categories were selected in order to filter the pixels. We used
`state_1km` and `qc_500m` variables for the filtering, given that the `q_scan`
provided no useful information about the quality and `g_flags` contained the same
exact value for all the observations. The bit strings selected for `state_1km`
are indicated in @tbl-state_1km_bitstrings and the ones for `qc_500` are shown
in @tbl-qc_scan_bit_strings.

The second stage of the data processing is to scale all the bands values. For
all the highest quality pixels obtained, we scaled every observation by a factor
of `0.0001`. According to documentation, any value after the scaling, outside of
the range from `0` to `1` were discarded given that these values are considered
a fill value or an uncorrected L1B data. Once we had all the bands values
scaled, the vegetation indices such as `NDVI` (@eq-ndvi), `NIRv` (@eq-nirv),
and `EVI` (@eq-evi) were calculated. Given that in the MODIS product with a
spatial resolution of 250m (`MODIS/061/MOD09A1`) there is no blue
band, `EVI` was not calculated for this dataset.

$$
NDVI = \frac{B02 - B01}{B02 + B01}
$$ {#eq-ndvi}

$$
NIRv = B02\times\frac{B02 - B01}{B02 + B01}
$$ {#eq-nirv}

$$
EVI = 2.5\times\frac{\mathrm{NIR} - \mathrm{Red}}{%
          (\mathrm{NIR} + 6\times \mathrm{Red}
          - 7.5\times \mathrm{Blue} + 1)}\\
$$ {#eq-evi}

For Harmonized Sentinel-2 data the data processing consisted on using the
`msk_cldprb` variable to filter out pixels according to the probabilities of
containing a cloud or the `msk_snwprb` variable for presence of snow
probability. Once the pixels without any probability of having clouds or
snow were filtered from the rest, we scaled all the reflectance bands 
observations by a factor of `0.0001`. With the values scaled we proceed to
calculate the vegetation indices `NDVI` (@eq-ndvis), `NIRv` (@eq-nirvs),
and `EVI` (@eq-evis). The bands used to calculate these indices are in
@tbl-harmonized_s2_indices_bands

$$
NDVI = \frac{b8 - b4}{b8 + b4}
$$ {#eq-ndvis}

$$
NIRv = b8\times\frac{b8 - b4}{b8 + b4}
$$ {#eq-nirvs}

$$
EVI = 2.5\times\frac{\mathrm{b8} - \mathrm{b4}}{%
          (\mathrm{b8} + 6\times \mathrm{b4}
          - 7.5\times \mathrm{b2} + 1)}\\
$$ {#eq-evis}

### Data Analysis


 - data summary for satellite data in daily, weekly, monthly
 - gpp values under 1 were filtered out  
 - Data matching of satellite data with flux data per day, week and month
 - GAM models for daily and weekly data
 - linear model for monthly data


## Results

```{r data_import}
#| echo: false
#| message: false
#| warning: false

library(readr)
library(dplyr)
library(ggplot2)
library(janitor)
library(tidyr)
library(cowplot)
library(lubridate)

# MICHIGAN ------
## Daily fluxes
file <-
  "data/FLX_US-UMB_FLUXNET2015_FULLSET_2007-2017_beta-4/FLX_US-UMB_FLUXNET2015_FULLSET_DD_2007-2017_beta-4.csv"

# Read the file
one_flux_daily <- read_csv(file) %>% 
  clean_names() %>% 
  # All NA values are written as -9999
  mutate_all(~na_if(., -9999)) %>% 
  mutate(date = ymd(timestamp)) %>% 
  select(-timestamp) %>% 
  filter(year(date) >= 2015)

## Weekly fluxes
file <- 
  "data/FLX_US-UMB_FLUXNET2015_FULLSET_2007-2017_beta-4/FLX_US-UMB_FLUXNET2015_FULLSET_WW_2007-2017_beta-4.csv"

one_flux_weekly <- read_csv(file) %>% 
  clean_names() %>% 
  # All NA values are written as -9999
  mutate_all(~na_if(., -9999)) %>% 
  mutate(date_start = ymd(timestamp_start),
         date_end = ymd(timestamp_end)) %>% 
  select(-timestamp_start, -timestamp_end) %>%
  filter(year(date_start) >= 2015)

## Monthly fluxes
file <-
  "data/FLX_US-UMB_FLUXNET2015_FULLSET_2007-2017_beta-4/FLX_US-UMB_FLUXNET2015_FULLSET_MM_2007-2017_beta-4.csv"

one_flux_monthly <- read_csv(file) %>% 
  clean_names() %>% 
  # All NA values are written as -9999
  mutate_all(~na_if(., -9999)) %>% 
  mutate(day = "01") %>% 
  unite(date, c("timestamp", "day"), sep = "") %>% 
  mutate(date = ymd(date)) %>% 
  mutate(date = zoo::as.yearmon(date)) %>% 
  filter(year(date) >= 2015)


```

The sites have the following GPP trends for the period available for each one:
See @fig-gpp_trends

```{r}
#| label: fig-gpp_trends
#| fig-cap: "GPP trends for Michigan"
#| fig-width: 7
#| fig-height: 9
#| echo: false
#| message: false
#| warning: false

# GPP trends
daily_gpp_trend <- one_flux_daily %>%
  select(date, starts_with("gpp")) %>%
  pivot_longer(-date, names_to = "gpp_method", values_to = "gpp_value") %>%
  filter(gpp_method %in% c("gpp_dt_vut_25",
                           "gpp_dt_vut_50",
                           "gpp_dt_vut_75",
                           "gpp_dt_vut_ref",
                           "gpp_nt_vut_25",
                           "gpp_nt_vut_50",
                           "gpp_nt_vut_75",
                           "gpp_nt_vut_ref"
  )) %>% 
  ggplot(aes(x = date, y = gpp_value, color = gpp_method)) +
  geom_point() +
  geom_line() +
  scale_color_viridis_d() +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  scale_y_continuous(breaks = seq(0, 60, by = 2)) +
  labs(x = "Date", y = expression(GPP~(gC~m^{"-2"}~d^-1)), color = "Index",
       title = "Oneflux daily GPP") +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, h = 1))

weekly_gpp_trend  <- one_flux_weekly %>%
  select(date_start, starts_with("gpp")) %>%
  pivot_longer(-date_start, names_to = "gpp_method", values_to = "gpp_value") %>%
  filter(gpp_method %in% c("gpp_dt_vut_25",
                           "gpp_dt_vut_50",
                           "gpp_dt_vut_75",
                           "gpp_dt_vut_ref",
                           "gpp_nt_vut_25",
                           "gpp_nt_vut_50",
                           "gpp_nt_vut_75",
                           "gpp_nt_vut_ref"
  )) %>% 
  ggplot(aes(x = date_start, y = gpp_value, color = gpp_method)) +
  geom_point() +
  geom_line() +
  scale_color_viridis_d() +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  scale_y_continuous(breaks = seq(0, 32, by = 2)) +
  labs(x = "Date", y = expression(GPP~(gC~m^{"-2"}~d^-1)), color = "Index",
       title = "Oneflux weekly GPP") +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, h = 1))

monthly_gpp_trend  <- one_flux_monthly %>%
  select(date, starts_with("gpp")) %>%
  pivot_longer(-date, names_to = "gpp_method", values_to = "gpp_value") %>%
  filter(gpp_method %in% c("gpp_dt_vut_25",
                           "gpp_dt_vut_50",
                           "gpp_dt_vut_75",
                           "gpp_dt_vut_ref",
                           "gpp_nt_vut_25",
                           "gpp_nt_vut_50",
                           "gpp_nt_vut_75",
                           "gpp_nt_vut_ref"
  )) %>% 
  mutate(date = zoo::as.Date(date)) %>%
  ggplot(aes(x = date, y = gpp_value, color = gpp_method)) +
  geom_point() +
  geom_line() +
  scale_color_viridis_d() +
  scale_x_date(date_labels = "%b%Y", breaks = "months") +
  scale_y_continuous(breaks = seq(0, 28, by = 2)) +
  labs(x = "Date", y = expression(GPP~(gC~m^{"-2"}~d^-1)), color = "Index",
       title = "Oneflux monthly GPP") +
  theme_light(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, h = 1))

plot_grid(daily_gpp_trend,
          weekly_gpp_trend,
          monthly_gpp_trend,
          nrow = 3)
```


## Discussion

## References

Just the references of this chapter, that also needs to be included in the final
references.

::: {#refs}
:::

## Figures

## Tables

| Site     | Data range available | Dataset name                                                | Reference                  |
|----------------|------------------------|------------------------|----------------|
| Bartlett | Jan 2015 to Dec 2017 | US-Bar: Barlett Experimental Forest (version: beta-3)       | [@staebler2019ameriflux]   |
| Borden   | Jan 2015 to Jan 2022 | CA-Cbo: Ontario - Mixed Deciduous, Borden Forest Site       | [@richardson2016ameriflux] |
| Michigan | Jan 2015 to Jan 2018 | US-UMB: Univ. of Mich. Biological Station (version: beta-4) | [@gough2016ameriflux]      |

: Sites ONEFlux datasets {#tbl-oneflux_datasets}

| Data                  | Spatial resolution (m) | GEE image collection         |
|-----------------------|------------------------|------------------------------|
| MODIS reflectance     | 500                    | MODIS/006/MOD09GA            |
| MODIS reflectance     | 250                    | MODIS/061/MOD09A1            |
| Harmonized Sentinel-2 | 20 - 60 - 10           | COPERNICUS/ S2_SR_HARMONIZED |

: Satellite images datasets {#tbl-satellite_images_datasets}

| **Name** | **Description** | **Resolution** | **Wavelength**                | **Scale** |
|---------------|---------------|---------------|----------------------|---------------|
| B4       | Red             | 10 meters      | 664.5nm (S2A) / 665nm (S2B)   | 0.0001    |
| B8       | NIR             | 10 meters      | 835.1nm (S2A) / 833nm (S2B)   | 0.0001    |
| B2       | Blue            | 10 meters      | 496.6nm (S2A) / 492.1nm (S2B) | 0.0001    |

: Harmonized Sentinel-2 Bands {#tbl-harmonized_s2_indices_bands}

| **Name**    | **Description** | **Resolution** | **Wavelength** | **Scale** |
|-------------|-----------------|----------------|----------------|-----------|
| sur_refl_01 | Red             | 500 meters     | 620-670nm      | 0.0001    |
| sur_refl_02 | NIR             | 500 meters     | 841-876nm      | 0.0001    |
| sur_refl_03 | Blue            | 500 meters     | 459-479nm      | 0.0001    |

: MOD09GA.061 MODIS Bands {#tbl-MODIS_500_indices_bands}

```{r}
#| label: tbl-state_1km_bitstrings
#| tbl-cap: "state_1km bit strings"
#| echo: false
#| message: false
#| warning: false

library(dplyr)
library(tibble)
library(gt)

tribble(
  ~Parameter, ~Bit, ~State,
  "cloud_state" , "00" , "clear",
  "cloud_state" , "01" , "cloudy",
  "cloud_state" , "10" , "mixed",
  "cloud_state" , "11" , "not set, assumed clear",
  "cloud_shadow_qa" , "1" , "yes", 
  "cloud_shadow_qa" , "0" , "no",
  "land_water_flag" , "000" , "shallow ocean",
  "land_water_flag" , "001" , "land",
  "land_water_flag" , "010" , "ocean coastlines and lake shorelines",
  "land_water_flag" , "011" , "shallow inland water",
  "land_water_flag" , "100" , "ephemeral water",
  "land_water_flag" , "101" , "deep inland water",
  "land_water_flag" , "110" , "continental/moderate ocean",
  "land_water_flag" , "111" , "deep ocean",
  "aerosol_quantity" , "00" , "climatology",
  "aerosol_quantity" , "01" , "low",
  "aerosol_quantity" , "10" , "average",
  "aerosol_quantity" , "11" , "high",
  "cirrus_detected" , "00" , "none",
  "cirrus_detected" , "01" , "small",
  "cirrus_detected" , "10" , "average",
  "cirrus_detected" , "11" , "high",
  "cloud_flag_qa" , "1", "cloud", 
  "cloud_flag_qa" , "0", "no cloud",
  "fire_flag_qa" , "1", "fire",
  "fire_flag_qa" , "0", "no fire",
  "snow_ice_flag_qa" , "1", "yes", 
  "snow_ice_flag_qa" , "0", "no",
  "pixel_adjacent_cloud_qa" , "1", "yes", 
  "pixel_adjacent_cloud_qa" , "0", "no", 
  "salt_pan_qa", "1", "yes",
  "salt_pan_qa" , "0", "no",
  "snow_mask_qa" ,  "1", "yes",
  "snow_mask_qa" ,  "0", "no"
) %>% 
  select(Bit, State) %>% 
  gt() %>% 
  tab_row_group(
    label = md("**Snow Mask**"),
    rows = 33:34
  ) %>% 
  tab_row_group(
    label = md("**Salt Pan Cloud**"),
    rows = 31:32
  ) %>%
  tab_row_group(
    label = md("**Pixel adjacent Cloud**"),
    rows = 29:30
  ) %>% 
  tab_row_group(
    label = md("**Snow Ice Flag**"),
    rows = 27:28
  ) %>% 
  tab_row_group(
    label = md("**Fire Flag**"),
    rows = 25:26
  ) %>% 
  tab_row_group(
    label = md("**Cloud Flag**"),
    rows = 23:24
  ) %>% 
  tab_row_group(
    label = md("**Cirrus Detected**"),
    rows = 19:22
  ) %>% 
  tab_row_group(
    label = md("**Aerosol Quantity**"),
    rows = 15:18
  ) %>% 
  tab_row_group(
    label = md("**Land Water**"),
    rows = 7:14
  ) %>% 
  tab_row_group(
    label = md("**Cloud Shadow**"),
    rows = 5:6
  ) %>% 
  tab_row_group(
    label = md("**Cloud State**"),
    rows = 1:4
  ) %>% 
  cols_align(align = "center", columns = everything())
```

```{r}
#| label: tbl-qc_scan_bit_strings
#| tbl-cap: "qc_scan bit strings"
#| echo: false
#| message: false
#| warning: false

tribble(
  ~Parameter, ~Bits, ~State,
  "modland" , "00" , "ideal quality - all bands",
  "modland" , "01" , "less than ideal quality - some or all bands",
  "modland" , "10" , "product not produced due to cloud effects",
  "modland" , "11" , "product not produced for other reasons",
  "bands" , "0000" , "highest_quality",
  "bands" , "0111" , "noisy detector",
  "bands" , "1000" , "dead detector, data interpolated in L1B",
  "bands" , "1001" , "solar zenith >= 86 degrees",
  "bands" , "1010" , "solar zenith >= 85 and < 86 degrees",
  "bands" , "1011" , "missing input",
  "bands" , "1100" , "internal constant used",
  "bands" , "1101" , "correction out of bounds",
  "bands" , "1110" , "L1B data faulty",
  "bands" , "1111" , "not processed due to deep ocean or clouds",
  "atmospheric_correction" , "0", "no",
  "atmospheric_correction" , "1", "yes",
  "adjacency_correction" ,  "0", "no",
  "adjacency_correction" ,  "1", "yes"
) %>% 
  select(Bits, State) %>% 
  gt() %>% 
  tab_row_group(
    label = md("**Adjacency Correction**"),
    rows = 17:18
  ) %>% 
  tab_row_group(
    label = md("**Atmospheric Correction**"),
    rows = 15:16
  ) %>% 
  tab_row_group(
    label = md("**Band quality (apply for all bands)**"),
    rows = 5:14
  ) %>% 
  tab_row_group(
    label = md("**Modland**"),
    rows = 1:4
  ) %>% 
  cols_align(align = "center", columns = everything()) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#B3B3B3")
    ),
    locations = cells_body(
      columns = State,
      rows = State %in% c("ideal quality - all bands",
                          "highest_quality",
                          "yes")
    )
  )
```
