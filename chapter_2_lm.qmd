---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Assesing uncertanties related to satellite remote sensing indices to estimate Gross Primary Production

## Introduction

Gross Primary Production (GPP) is the total amount of carbon fixation by plants
through photosynthesis [@badgley_terrestrial_2019]. Quantifying GPP is essential
for understanding land-atmosphere carbon exchange [@kohler_global_2018],
ecosystem function, and ecosystem responses to climate change
[@guan_comparison_2022; @brown_fiducial_2021; @myneni_relationship_1994]. With
recent advances in technology for remote sensing and more computational power
available with lower costs [@gorelick_google_2017], global mapping of
photosynthesis is being done by more scientists [@ryu_what_2019]. Given that GPP
cannot be directly estimated from satellite remote sensing techniques, the use
of vegetation indices has been a widely used method to approximate and quantify
GPP [@ryu_what_2019]. However, estimates remain with high uncertainties and
validation efforts are required to characterize these and improve accuracy.
[@anav_spatiotemporal_2015; @brown_fiducial_2021]

There are several methods to calculate GPP that can be grouped into two broad
categories: eddy covariance techniques, and satellite data-driven
[@guan_comparison_2022; @xie_assessments_2020] Eddy Covariance (EC) techniques
are methods that allowed scientists to directly measure the carbon, water, and
energy fluxes between vegetation canopies and the atmosphere since the 1990s
[@baldocchi_how_2020; @ryu_what_2019]. This method to measure terrestrial
fluxes, is the principal approach for quantifying the exchange of CO2 between
the land and atmosphere using advanced field instrumentation
[@badgley_terrestrial_2019; @tramontana_predicting_2016]. Measurements provided
using EC have a limited spatial resolution of less than \< 1km2 , which bring
spatial constraints to estimations of ecosystem carbon and water fluxes at
regional to global scales. [@badgley_canopy_2017].

The second category of methods to estimate GPP is the satellite data-driven
models. Because of their dependency on earth observation platforms, they are not
spatially constrained but can have more uncertainties than the EC techniques
[@ryu_what_2019; @wang_diagnosing_2011]. Satellite data-driven models can be
classified into Vegetation Index models (VI), Light Use Efficiency models (LUE),
and process-based models [@xie_assessments_2020].

LUE models are based on the concept of radiation conversion efficiency, and take
into consideration ecological processes [@liu1997process]. The radiation
conversion efficiency explains the amount of carbon that a specific type of
vegetation can fix per unit of solar radiation [@monteith_solar_1972]. The
Moderate Resolution Imaging Spectroradiometer (MODIS) GPP product uses an 
algorithm based on this radiation conversion efficiency concept, relating the
absorbed photosynthetically active radiation (APAR) with the LUE term [@heinsch_evaluation_2006] as shown in @eq-gpp .

$$
GPP = PAR \times fAPAR \times LUE
$$ {#eq-gpp}

Where PAR is the incident photosynthetically active radiation and fAPAR is the
fraction of the PAR that is effectively absorbed by plants. fAPAR can be used to
assess the primary productivity of canopies [GCOS, 2011;
@running_continuous_2004]. LUE is the radiation use conversion efficiency term
of the vegetation [@heinsch_evaluation_2006]

VI's are a summary of satellite obtained spectral data
[@myneni_relationship_1994] derived from optical sensors that are combined with
climate variables to calculate GPP [@wu_predicting_2011]. This is usually done
with some form of regression and physical methods that associate interactions
between vegetation and incoming radiation [@fernandez-martinez_monitoring_2019]

Well known VI's used to estimate GPP are normalized difference vegetation index
(NDVI), enhanced vegetation index (EVI), leaf area index (LAI), and fraction of
photosynthetically active radiation (fPAR) among others
[@balzarolo_influence_2019; @rahman_potential_2005; @rahman_potential_2005;
@xie_assessments_2020; @badgley_terrestrial_2019; @zhang_potential_2020;
@sellers_global_1994]

Nonetheless, even when estimating GPP from satellite remote sensing methods is
promising to overcome limitations as temporal and spatial scale, there are some
challenges involved in the process. The first constraint is the use of images
needed to address the problem of mixed-pixels, which requires determining the
fraction of the vegetated surface and its attributable signal
[@badgley_canopy_2017]. A second challenge is that photosynthesis regulation can
occur with no major changes in canopy structure or leaf pigments that can
undergo without being detected with reflectance data
[@pabon-moreno_potential_2022; @pierrat_diurnal_2022]

The accuracy of GPP estimation through the use of VI's can be affected due to
their limitation to predict spatial, temporal, interannual variability and
trends. [@fernandez-martinez_monitoring_2019]. An index such as NDVI is good for
detecting changes in seasonal variability, but it becomes saturated with high
biomass conditions [@badgley_canopy_2017]. Other indices such as EVI can
overcome this problem and be better suited for predicting GPP in large biomass
forests [@badgley_canopy_2017] but it has been evaluated in a narrow range of
ecosystems and needs inputs of start and end dates of the growing seasons which
can increase uncertainties [@shi_assessing_2017].

To overcome these problems, other indices have been formulated in recent years.
One of these VIs is near-infrared reflectance index (NIRv)
[@badgley_terrestrial_2019] NIRv is defined as the fraction of reflected NIR
light that originates from vegetation. NIRv was originally proposed as a
replacement for fPAR in LUE models in that the NIR and PAR reflectance of
vegetation are correlated and the scaling by NDVI corrects for soil
contributions in the signal [@badgley_terrestrial_2019] NIRv has been shown to
have a stronger correlation to GPP at flux towers and on a regional basis than
fAPAR notwithstanding the fact that GPP is fAPAR driven. NIRv has been extended
to include a weighting with PAR [@dechant_nirvp_2022] and replacing the NIR
reflectance with NIRv radiance [@wu_radiance-based_2020]. Both of these
approaches have been shown to have even stronger correlations with GPP than NIRv
as could be expected since they either directly or indirectly weight the NIRv
with PAR.

The stronger correlation between the NIR indices to GPP versus indices based on
fAPAR seemingly contradicts the hypotheses in the LUE model that GPP should be
linearly related to fAPAR. There are two explanations: i. Many of the reported
comparative studies use fAPAR based on VIs and not APAR. We hypothesize that the
NIR indices are simply better estimators of APAR than these VI approximations
due to lower measurement error for the NIR indices or a stronger physical
relationship between them and APAR versus the historical VIs. The strength of
correlation between APAR and GPP depends on LUE having a linear relationship to
observed APAR. While this may hold in some circumstances (e.g. early seasonal
measurements for vegetation such as crops where leaf chlorophyll concentration
increases during the growth phase) it is not the case in general and definitely
during stress conditions [@monteith_solar_1972].

Despite these efforts, relying solely on these remote satellite indices is a
problem. Efforts to validate and quantify their accuracy are needed
[@brown_fiducial_2021]. In-situ eddy-covariance flux measurements represent a
solution given that they represent site-level observations. With the calculation
of the flux footprint, the area from the flux tower can serve as a reference
point in which satellite images can be linked to a specific set of pixels and
calculate the accuracy of the estimations provided by the indices.
[@chu_representativeness_2021].

As such, the main objective of my M.Sc. thesis is the analysis of uncertainty
associated with the VI/LUE models since they offer the potential for GPP
estimation without requiring knowledge regarding canopy and soil properties
other than measurements of reflected light and possibly a correction for soil
contribution. We aim to quantify the uncertainty from some of the most used
satellite vegetation indices with in-situ GPP data from the Bartlett
Experimental Forest (USA), the Borden Forest Research Station flux-site
(Canada), and the University of Michigan Biological Station (USA).

\newpage

## Methods

```{r libraries and sources}
#| echo: false
#| message: false
#| warning: false

# Libraries
library(ggplot2)
library(cowplot)
library(lubridate)
library(purrr)
library(broom)
library(gt)
library(tidymodels)
library(broom)
library(usemodels)
library(vip)
library(h2o)
library(mgcv) 

# Source files
# Source the objects created for the complete GPP trends.
# This file will source the code and load objects to memory.
source("scripts/trend_plots.R")

# Source the objects created for the complete GPP trends
source("scripts/models_data_preparation.R")

# Source file with functions to plot rf predictions
source("R/plot_exploratory.R")
```

### Eddy Covariance sites

We used three deciduous broadleaf forest sites located in the northern 
hemisphere with eddy covariance (EC) data collected by Ameriflux. For each site,
we used daily, weekly, and monthly GPP (GPP_DT_VUT_REF variable) data estimated
using the FLUXNET2015 workflow [@pastorello2020fluxnet2015]. The ONEFlux 
processing does the estimation of the CO~2~ fluxes into GPP and Ecosystem 
Respiration (RECO) from Net Ecosystem Exchange (NEE) through two methods known
as daytime and nighttime. Here we selected the daytime method (DT) which uses
daytime and nighttime to parameterize a model with two components: one based on 
light response curve and vapour pressure deficit and a second one using a
respiration-temperature relationship to estimate RECO which in turn is used to
obtain the difference with NEE and provide GPP. [@pastorello2020fluxnet2015].

For each site, GPP was used in the analysis with three datasets representing daily, weekly, and monthly time scales. @fig-michigan_gpp_trends displays the GPP trends for the University of Michigan Biological Station, @fig-bartlett_gpp_trends illustrates the GPP trends for the Bartlett experimental forest, and @fig-borden_gpp_trends showcases the GPP trends for the Borden Forest Research Station. Additional details regarding the characteristics of these datasets can be found in Table @tbl-oneflux_datasets.

| Site     | Data range available | Dataset name                                                | Reference                  |
|-------------------|---------------------|---------------------|-------------------|
| Bartlett | Jan 2015 to Dec 2017 | US-Bar: Barlett Experimental Forest (version: beta-3)       | [@staebler2019ameriflux]   |
| Borden   | Jan 2015 to Jan 2022 | CA-Cbo: Ontario - Mixed Deciduous, Borden Forest Site       | [@richardson2016ameriflux] |
| Michigan | Jan 2015 to Jan 2018 | US-UMB: Univ. of Mich. Biological Station (version: beta-4) | [@gough2016ameriflux]      |

: Sites ONEFlux datasets {#tbl-oneflux_datasets}

The Bartlett experimental forest is located in New Hampshire, USA (44°06′N,
71°3′W). This site is characterized by a forest with an average canopy height 
ranging from 20 to 22 meters with a mean annual temperature of 6C. 
Despite events such as a hurricane in 1938 and small scale forest management,
the forest mean stand age is around 120-125 years. [@ouimette_carbon_2018]

The second flux site is Borden Forest Research Station located in Ontario
(44°19′N, 79°56′W), Canada. This is one of the largest patches of forest in
Southern Ontario which has been collecting EC data since 1996
[@rogers_response_2020]. This site has a forest cover of over 60% with a height
that exceeds 2 m. It's a deciduous broadleaf natural re-growth forest dominated
by woody vegetation. [@lee_long-term_1999].

The third site is the University of Michigan Biological Station which is located
in northern Michigan, USA (45°350 N 84°430 W). The site have a forest with
different succesional stages and a mean height of 2m. Mean annual temperature is
around 5.5°C. [@gough_disturbanceaccelerated_2021]

The sites have the following GPP trends for the period available for each one:
See @fig-michigan_gpp_trends

```{r}
#| label: fig-michigan_gpp_trends
#| fig-cap: "GPP trends for Michigan"
#| fig-width: 7
#| fig-height: 9
#| echo: false
#| message: false
#| warning: false
michigan_gpp_trends
```

```{r}
#| label: fig-borden_gpp_trends
#| fig-cap: "GPP trends for Borden"
#| fig-width: 7
#| fig-height: 9
#| echo: false
#| message: false
#| warning: false
borden_gpp_trends
```

```{r}
#| label: fig-bartlett_gpp_trends
#| fig-cap: "GPP trends for Bartlett"
#| fig-width: 7
#| fig-height: 9
#| echo: false
#| message: false
#| warning: false
bartlett_gpp_trends
```

<!-- The GPP for each of the sites can -->

<!-- -   include description of the ONEFlux processing (gap filling, data quality, -->
<!--     gpp estimation, gpp uncertainty with DT and NT) -->

### Satellite imagery

We used Google Earth Engine (GEE) to retrieve data from the Terra Moderate 
Resolution Imaging Spectroradiometer (MODIS), specifically the collection 
MOD09GA Version 6.1 product. A square polygon with an area of 3km surrounding 
the EC tower was defined for each site, and the complete data pixel values 
within this polygon was extracted for analysis.

The MODIS (MOD09GA Version 6.1 product) contains the surface spectral reflectance
from bands to 1 through 7 with a spatial resolution of 500m, with corrections 
for atmospheric conditions such as aerosols, gasses and Rayleigh scattering 
[@vermote2021modis]. Bands used to derived the vegetation indices are shown in
@tbl-MODIS_500_indices_bands


| **Name**    | **Description** | **Resolution** | **Wavelength** | **Scale** |
|-------------|-----------------|----------------|----------------|-----------|
| sur_refl_01 | Red             | 500 meters     | 620-670nm      | 0.0001    |
| sur_refl_02 | NIR             | 500 meters     | 841-876nm      | 0.0001    |
| sur_refl_03 | Blue            | 500 meters     | 459-479nm      | 0.0001    |
| sur_refl_04 | Green           | 500 meters     | 545-565nm      | 0.0001    |

: MOD09GA.061 MODIS Bands {#tbl-MODIS_500_indices_bands}

<!-- | Data                  | Spatial resolution (m) | GEE image collection         | -->
<!-- |-----------------------|------------------------|------------------------------| -->
<!-- | MODIS reflectance     | 500                    | MODIS/006/MOD09GA            | -->
<!-- | MODIS reflectance     | 250                    | MODIS/061/MOD09A1            | -->
<!-- | Harmonized Sentinel-2 | 20 - 60 - 10           | COPERNICUS/ S2_SR_HARMONIZED | -->

<!-- : Satellite images datasets {#tbl-satellite_images_datasets} -->

The data processing involved three main steps: filtering high-quality pixels,
scaling band values, and calculating vegetation indices. High-quality pixels
were filtered using four bit-encoded variables: `state_1km`, `qc_500m`,
`q_scan`, and `g_flags` along with each of the bands bits quality indicators.
These variables provided information about the observation quality. The
bit-encoded variables were transformed into categorical strings, and only the
categories indicating the best quality were selected to filter the pixels (@fig-quality_pixels).

For filtering, the `state_1km` and `qc_500m` variables were used, as `q_scan` 
was not informative and `g_flags` had the same value for all observations. The
specific bit strings selected for `state_1km` are shown in
@tbl-state_1km_bitstrings and for `qc_500m` in @tbl-qc_scan_bit_strings.

In the second stage of the data processing, after filtering for the highest
quality pixels, all the bands values were scaled. For each observation,
regardless of the specific band, a scaling factor of `0.0001` was applied. This
scaling factor was used to adjust the magnitude of the values and ensure
consistency in the data.

According to the documentation, any scaled value that fell outside the range of
`0` to `1` was considered a fill value or uncorrected Level 1B data and was
subsequently discarded. These values were deemed unreliable or lacking
meaningful information for the analysis. The complete selected high quality
pixels for the complete period per each of the sites is shown in @fig-complete_quality_pixels

Once all the band values were scaled within the valid range the vegetation
indices such as `NDVI` (@eq-ndvi), `NIRv` (@eq-nirv), `EVI` (@eq-evi),
`kNDVI` (@eq-kndvi), and `CCI` (@eq-cci) were calculated and then matched with
the corresponding date in the flux datasets. The resulting values used for the
analysis are shown in @fig-quality_pixels

<!-- However, since the -->
<!-- MODIS product with a spatial resolution of 250m (`MODIS/061/MOD09A1`) does not -->
<!-- include the blue band EVI calculations were not performed for this dataset. -->

$$
NDVI = \frac{NIR - Red}{NIR + Red}
$$ {#eq-ndvi}

$$
NIRv = NIR\times\frac{NIR - Red}{NIR + Red}
$$ {#eq-nirv}

$$
EVI = 2.5\times\frac{\mathrm{NIR} - \mathrm{Red}}{%
          (\mathrm{NIR} + 6\times \mathrm{Red}
          - 7.5\times \mathrm{Blue} + 1)}\\
$$ {#eq-evi}


$$
kNDVI = tanh(\mathrm{NDVI}^2)
$$ {#eq-kndvi}

$$
CCI = \frac{Green - Red}{Green + Red}
$$ {#eq-cci}

<!-- For Harmonized Sentinel-2 data the data processing consisted on using the -->
<!-- `msk_cldprb` variable to filter out pixels according to the probabilities of -->
<!-- containing a cloud or the `msk_snwprb` variable for presence of snow -->
<!-- probability. Once the pixels without any probability of having clouds or snow -->
<!-- were filtered from the rest, we scaled all the reflectance bands observations by -->
<!-- a factor of `0.0001`. With the values scaled we proceed to calculate the -->
<!-- vegetation indices `NDVI` (@eq-ndvis), `NIRv` (@eq-nirvs), and `EVI` (@eq-evis). -->
<!-- The bands used to calculate these indices are in -->
<!-- @tbl-harmonized_s2_indices_bands -->

<!-- $$ -->
<!-- NDVI = \frac{b8 - b4}{b8 + b4} -->
<!-- $$ {#eq-ndvis} -->

<!-- $$ -->
<!-- NIRv = b8\times\frac{b8 - b4}{b8 + b4} -->
<!-- $$ {#eq-nirvs} -->

<!-- $$ -->
<!-- EVI = 2.5\times\frac{\mathrm{b8} - \mathrm{b4}}{% -->
<!--           (\mathrm{b8} + 6\times \mathrm{b4} -->
<!--           - 7.5\times \mathrm{b2} + 1)}\\ -->
<!-- $$ {#eq-evis} -->

### Data Preparation

In the study, three datasets were prepared for each site: a daily dataset, a
weekly dataset, and a monthly dataset. These datasets were generated from the
satellite imagery data with the selected high quality pixels and the
ONEFluxprocess data in order to capture variations in vegetation indices (VI),
band values, and GPP over different time scales.

The daily dataset included the VI values, band values only from the high quality
pixels, and GPP measurements derived from the ONEFlux process collected on a
daily basis. This dataset provided a high-resolution representation of the
variables, allowing for a detailed analysis of their daily fluctuations.

The weekly and monthly datasets were derived from the corresponding daily
dataset. These datasets contained summarized values of the VI's and band values,
aggregated over the weekly and monthly time frames, respectively. The
aggregation process involved calculating an average for the VI's and band values
within each week or month.

For the GPP values in the weekly and monthly datasets, rather than summarizing
the daily GPP values, the GPP measurements for the weekly and monthly time
frames were obtained directly from the ONEFlux process, which provided a
reliable estimation of GPP for these longer time intervals.

By creating these three datasets (daily, weekly, and monthly), the study allowed
for a comprehensive analysis of the VI's, band values, and GPP at different
temporal resolutions. This approach provided insights into the temporal dynamics
and patterns of the variables, enabling a more thorough understanding of the
ecological processes and relationships under investigation.

For each site and across all time scales (daily, weekly, and monthly), a
filtering step was implemented to remove GPP values
that were less than 1 gC m^-2^ d^-1^ . By filtering out GPP values less than 1,
the study aimed to exclude values that were potentially unreliable or
insignificant in terms of representing meaningful vegetation productivity. GPP
values below this threshold were considered to be either below the detection
limit or not enough to contribute significantly to the overall analysis.

```{r}
#| label: fig-quality_pixels
#| fig-cap: "Total number of observations (pixels) from MODIS classified as high quality (used in the analysis) or other quality (filtered out from the analysis) per site."
#| echo: false
#| message: false
#| warning: false
source("scripts/quality_observations.R")

all %>% 
  ggplot(aes(x = site, fill = quality)) +
  geom_bar(position = "stack") +
  scale_fill_viridis_d(begin = 0.34, end = 0.8) +
  labs(x = "Site", 
       y = "Total observations (pixels)",
       fill = "Quality") +
  theme_bw(base_size = 12)
```

```{r}
#| label: fig-obs_used_analysis
#| fig-cap: "Monthly distribution of high-quality MODIS observations after joining with flux observations containing Gross Primary Productivity (GPP) values higher than 1."
#| echo: false
#| message: false
#| warning: false

# Dataset used to analyze the data
daily_plot_500 %>% 
  # Dataset have all indices per row, so for the same date there are 5 obs
  filter(index == "ndvi_mean") %>% 
  group_by(site, date) %>% 
  tally() %>% 
  group_by(site) %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  ggplot(aes(x = year_mon, fill = site)) +
  geom_bar(position = "stack") +
  scale_fill_viridis_d(begin = 0.2, end = 0.8) +
  labs(x = "Date",
       y = "Total observations",
       fill = "Site") +
  theme_bw(base_size = 12) 

# daily_plot_500 %>% 
#   pivot_wider(names_from = index, values_from = value) %>% 
#   select(date, total_obs, site) %>% 
#   mutate(year_mon = zoo::as.yearmon(date)) %>% 
#   group_by(site, year_mon) %>% 
#   tally() %>% 
#   ungroup() %>% 
#   mutate(year_mon = as.factor(year_mon)) %>%
#   ggplot(aes(x = year_mon, y = n, fill = site)) +
#   geom_bar(stat = "identity", position = "stack") +
#   scale_fill_viridis_d(begin = 0.2, end = 0.8) +
#   labs(x = "Date",
#        y = "Total observations",
#        fill = "Site") +
#   theme_bw(base_size = 12) +
#   theme(axis.text.x = element_text(angle = 90, h = 1))
```

### Data Analysis

Various methodologies were employed to estimate GPP
by utilizing VIs and spectral bands derived from satellite
images. The choice of model for GPP estimation varied depending on the specific
time scale under consideration. This approach aimed to enhance the accuracy of
GPP estimation by employing models tailored to the characteristics of each time
scale.

#### LM for monthly data

Considering the reduced variability observed when the data values were 
aggregated on a monthly time scale, a linear model was was selected to estimate 
GPP. In total, nine models were constructed to assess the performance of each VI 
individually at each site. This comprehensive analysis aimed to evaluate and 
compare the effectiveness of the different VIs in capturing GPP variations within 
the study sites.

#### GAM models for daily and weekly data

Considering the non-normal distribution and variability observed in the data
values for both daily and weekly datasets, a Generalized Additive Model (GAM)
was developed to estimate GPP.


```{r gpp_vi_realtions_all_sites}
#| label: fig-gpp_vi_relation
#| fig-cap: "Relationship between MODIS 500m derived vegetation indices and GPP. Every observation corresponds to the observed GPP from a flux tower site (Borden Forest Research Station, Bartlett Experimental Forest or U. Michigan Biological Station) The summarized vegetation indices NDVI (Normalized difference vegetation index), NIRv (Near Infrared vegetation), CCI (Chlorophyll/Carotenoid Index), kNDVI (Normalized Difference Vegetation Index based on kernel methods), and EVI (Enhanced Vegetation Index) per date (daily, weekly, and monthly). The number of pixels corresponds to the number of observations used to obtain the mean of the vegetation index. The red line indicates the Generalized Additive Model for the daily and weekly relations and the Lineal Model for monthly values"
#| fig-width: 7
#| fig-height: 9
#| echo: false
#| message: false
#| warning: false

## Make sure the source of file "scripts/trend_plots.R" was successful
etiquetas <- c(
  "evi_mean" = "EVI",
  "ndvi_mean" = "NDVI",
  "nirv_mean" = "NIRv",
  "kndvi_mean" = "kNDVI",
  "cci_mean" = "CCI",
  "Borden" = "Borden",
  "Michigan" = "Michigan",
  "Bartlett" = "Bartlett"
)

daily_grid <-
  daily_plot_500 %>% 
  # filter(ndvi_mean > 3 & gpp_dt_vut_ref < 20)
  mutate(month = lubridate::month(date, label = TRUE)) %>% 
  ggplot(aes(x = value, y = gpp_dt_vut_ref)) +
  geom_point(aes(color = month, size = total_obs), alpha = 0.8) +
  geom_smooth(method = "gam", se = FALSE, color = "#E20D6A") +
  scale_color_viridis_d() + 
  scale_fill_viridis_d(aes(month)) +
  facet_grid(site~index, scales = "free", labeller = as_labeller(etiquetas)) +
  scale_size(range = c(.1, 5), name = "Number of pixels") +
  scale_x_continuous(breaks = seq(-1, 1, by = .1)) +
  scale_y_continuous(breaks = seq(0, 38, by = 4)) +
  labs(x = "Index value", 
       y = expression(GPP~(gC~m^{"-2"}~d^-1)),
       color = "Month", 
       title = "Daily observations with 500m spatial resolution") +
  theme_classic(base_size = 10) +
  theme(axis.text.x = element_text(angle = 60, h = 1)) +
  guides(size = guide_legend(order = 1, keyheight = 0.1),
         col = guide_legend(order = 2, keyheight = 0.1)) +
  theme(strip.text = element_text(size = 10, color = "black"),
        strip.background = element_blank())

weekly_grid <-
  weekly_plot_500 %>% 
  mutate(month = lubridate::month(date_start, label = TRUE)) %>% 
  ggplot(aes(x = value, y = gpp_dt_vut_ref)) +
  geom_point(aes(color = month, size = total_obs), alpha = 0.8) +
  geom_smooth(method = "gam", se = FALSE, color = "#E20D6A") +
  scale_color_viridis_d() + 
  scale_fill_viridis_d(aes(month)) +
  facet_grid(site~index, scales = "free", labeller = as_labeller(etiquetas)) +
  scale_size(range = c(.1, 5), name = "Number of pixels") +
  scale_x_continuous(breaks = seq(-1, 1, by = .1)) +
  scale_y_continuous(breaks = seq(0, 38, by = 4)) +
  labs(x = "Index value", 
       y = expression(GPP~(gC~m^{"-2"}~d^-1)),
       color = "Month", 
       title = "Weekly observations with 500m spatial resolution") +
  theme_classic(base_size = 10) +
  theme(axis.text.x = element_text(angle = 60, h = 1)) +
  guides(size = guide_legend(order = 1, keyheight = 0.1),
         col = guide_legend(order = 2, keyheight = 0.1)) +
  theme(strip.text = element_text(size = 10, color = "black"),
        strip.background = element_blank())

monthly_grid <-
  monthly_plot_500 %>% 
  mutate(month = lubridate::month(date, label = TRUE)) %>% 
  ggplot(aes(x = value, y = gpp_dt_vut_ref)) +
  geom_point(aes(color = month, size = total_obs), alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE, color = "#E20D6A") +
  scale_color_viridis_d() + 
  scale_fill_viridis_d(aes(month)) +
  facet_grid(site~index, scales = "free", labeller = as_labeller(etiquetas)) +
  scale_size(range = c(.1, 5), name = "Number of pixels") +
  scale_x_continuous(breaks = seq(-1, 1, by = .1)) +
  scale_y_continuous(breaks = seq(0, 18, by = 4)) +
  labs(x = "Index value", 
       y = expression(GPP~(gC~m^{"-2"}~d^-1)),
       color = "Month", 
       title = "Monthly observations with 500m spatial resolution") +
  theme_classic(base_size = 10) +
  theme(axis.text.x = element_text(angle = 60, h = 1)) +
  guides(size = guide_legend(order = 1, keyheight = 0.1),
         col = guide_legend(order = 2, keyheight = 0.1)) +
  theme(strip.text = element_text(size = 10, color = "black"),
        strip.background = element_blank())

plot_grid(daily_grid,
          weekly_grid,
          monthly_grid,
          nrow = 3,
          labels = c('A', 'B', 'C'))
```

\newpage

## Results

### Monthly GPP and VI's relations

The @tbl provides a summary of linear models used for 
GPP estimation at each site, employing the vegetation
indices as predictors. For each site and predictor, the table includes the 
relevant model summary statistics, such as r-squared, adjusted r-squared, 
root mean square error (RMSE), p-value, as well as other metrics like the Akaike 
Information Criterion (AIC) and Bayesian Information Criterion (BIC). These 
statistics serve to assess the performance and accuracy of the linear models in 
estimating GPP using vegetation indices as predictors.

Based on the Root Mean Square Error (RMSE), NDVI performed less favourably  on 
two out of the three sites. However, the performance difference among the sites 
was not substantial, with the Bartlett experimental forest exhibiting slightly 
better results compared to the other sites. These findings suggest that while 
NDVI may not be the optimal vegetation index for GPP estimation at these sites,
there may still be variations in performance across different locations.

The complete metrics results for each of the monthly lm models are in
@tbl-complete_lm_monthly_results

\begingroup
\setlength{\LTleft}{0pt minus 500pt}
\setlength{\LTright}{0pt minus 500pt}
\fontsize{5pt}{7pt}\selectfont
\addtolength{\tabcolsep}{-3pt}

```{r lm_monthly}
#| label: tbl-lm_monthly_results
#| tbl-cap: "Summary of Linear models for GPP estimation using the vegetation indices on a monthly (a), weekly (b), and daily (c) basis."
#| tbl-colwidths: [50,50]
#| echo: false
#| message: false
#| warning: false
source("scripts/lm_preparation.R")

# Monthly table
bind_rows(evi_glance_monthly,
          ndvi_glance_monthly,
          nirv_glance_monthly,
          cci_glance_monthly) %>% 
  select(site, index, r.squared, adj.r.squared, rmse) %>%
  bind_rows(all_sites_glance_monthly,
            all_sites_all_indices_glance_monthly,
            all_vis_glance_monthly) %>% 
  pivot_wider(names_from = index, 
              values_from = c(r.squared, adj.r.squared, rmse)) %>%
  gt() %>%
  tab_spanner(label = md("NDVI"), columns = ends_with("NDVI")) %>%
  tab_spanner(label = "EVI", columns = ends_with("EVI")) %>%
  tab_spanner(label = "NIRv", columns = ends_with("NIRv")) %>%
  tab_spanner(label = "CCI", columns = ends_with("CCI")) %>% 
  tab_spanner(label = "All", columns = ends_with("All")) %>% 
  cols_label(
    .list = list(
      "site" = "Site",
      "r.squared_EVI" = "R2",
      "adj.r.squared_EVI" = "adj R2",
      "rmse_EVI" = "RMSE",
      "r.squared_NDVI" = "R2",
      "adj.r.squared_NDVI" = "adj R2",
      "rmse_NDVI" = "RMSE",
      "r.squared_NIRv" = "R2",
      "adj.r.squared_NIRv" = "adj R2",
      "rmse_NIRv" = "RMSE",
      "r.squared_CCI" = "R2",
      "adj.r.squared_CCI" = "adj R2",
      "rmse_CCI" = "RMSE",
      "r.squared_All" = "R2",
      "adj.r.squared_All" = "adj R2",
      "rmse_All" = "RMSE"
    )
  ) %>% 
  fmt_number(
    columns = 2:13,
    decimals = 2) %>% 
  tab_options(
    row_group.background.color = "#E9E0E1",
    row_group.font.weight = "bold"
  ) %>% 
  cols_width(everything() ~ px(50))

# Weekly table
bind_rows(evi_glance_weekly,
          ndvi_glance_weekly,
          nirv_glance_weekly,
          cci_glance_weekly) %>% 
  select(site, index, r.squared, adj.r.squared, rmse) %>%
  bind_rows(all_sites_glance_weekly) %>% 
  pivot_wider(names_from = index, 
              values_from = c(r.squared, adj.r.squared, rmse)) %>%
  gt() %>%
  tab_spanner(label = md("NDVI"), columns = ends_with("NDVI")) %>%
  tab_spanner(label = "EVI", columns = ends_with("EVI")) %>%
  tab_spanner(label = "NIRv", columns = ends_with("NIRv")) %>%
  tab_spanner(label = "CCI", columns = ends_with("CCI")) %>% 
  cols_label(
    .list = list(
      "site" = "Site",
      "r.squared_EVI" = "R2",
      "adj.r.squared_EVI" = "adj R2",
      "rmse_EVI" = "RMSE",
      "r.squared_NDVI" = "R2",
      "adj.r.squared_NDVI" = "adj R2",
      "rmse_NDVI" = "RMSE",
      "r.squared_NIRv" = "R2",
      "adj.r.squared_NIRv" = "adj R2",
      "rmse_NIRv" = "RMSE",
      "r.squared_CCI" = "R2",
      "adj.r.squared_CCI" = "adj R2",
      "rmse_CCI" = "RMSE"
    )
  ) %>% 
  fmt_number(
    columns = 2:13,
    decimals = 2) %>% 
  tab_options(
    row_group.background.color = "#E9E0E1",
    row_group.font.weight = "bold"
  ) %>% 
  cols_width(everything() ~ px(50))

# Daily table
bind_rows(evi_glance_daily,
          ndvi_glance_daily,
          nirv_glance_daily,
          cci_glance_daily) %>% 
  select(site, index, r.squared, adj.r.squared, rmse) %>%
  bind_rows(all_sites_glance_daily) %>% 
  pivot_wider(names_from = index, 
              values_from = c(r.squared, adj.r.squared, rmse)) %>%
  gt() %>%
  tab_spanner(label = md("NDVI"), columns = ends_with("NDVI")) %>%
  tab_spanner(label = "EVI", columns = ends_with("EVI")) %>%
  tab_spanner(label = "NIRv", columns = ends_with("NIRv")) %>%
  tab_spanner(label = "CCI", columns = ends_with("CCI")) %>% 
  cols_label(
    .list = list(
      "site" = "Site",
      "r.squared_EVI" = "R2",
      "adj.r.squared_EVI" = "adj R2",
      "rmse_EVI" = "RMSE",
      "r.squared_NDVI" = "R2",
      "adj.r.squared_NDVI" = "adj R2",
      "rmse_NDVI" = "RMSE",
      "r.squared_NIRv" = "R2",
      "adj.r.squared_NIRv" = "adj R2",
      "rmse_NIRv" = "RMSE",
      "r.squared_CCI" = "R2",
      "adj.r.squared_CCI" = "adj R2",
      "rmse_CCI" = "RMSE"
    )
  ) %>% 
  fmt_number(
    columns = 2:13,
    decimals = 2) %>% 
  tab_options(
    row_group.background.color = "#E9E0E1",
    row_group.font.weight = "bold"
  ) %>% 
  cols_width(everything() ~ px(50))
```

\endgroup

### Daily and weekly GPP and VI's relations

<!-- **TODO: Single vs Individual GAM model** -->

<!-- *This is a section under construction. Several models are presented in order -->
<!-- to discuss which one will be better to describe the patterns found* -->

<!-- Richard's suggestion is to create a single model using all indices as covariates. -->
<!-- The notes are described also in the issue [Ref #49](https://github.com/ronnyhdez/thesis_msc/issues/49) -->

<!-- **Single model** -->

<!--  - Using all the indices that I have as multiple predictors will allow me to  -->
<!--  explore the relation between GPP and each VI while also considering potential -->
<!--  interactions. But this will be an examination of the combined effects of the  -->
<!--  VIs on GPP and determine their relative importance. -->

<!-- **Individual model** -->

<!--  - A separate GAM model for each VI will allow me to explore the relation  -->
<!--  between GPP and each VI separately, without the exploration of potential  -->
<!--  interactions between the VIs.  -->

<!--  - But, do I want to explore if there are interactions? If there is an  -->
<!--  interaction, what would be the meaning of an interaction between indices? -->

<!--  - With the individual GAM models, I think that I can uncover individual trends, that otherwise would be hidden among all the VIs. [**simpson's paradox**](https://en.wikipedia.org/wiki/Simpson%27s_paradox) -->


```{r}
source("scripts/gam_preparation.R")


```


\newpage

## Discussion



Corporis cumque voluptate cum fuga consequuntur pariatur. Excepturi perspiciatis omnis dolores dolorum officiis a consequatur. Quae distinctio quae ullam sit id. Quasi minima voluptatibus nihil ut quibusdam aut tempore nam. Repudiandae quasi quis ipsa aut. Temporibus ut rerum ea a est voluptate.

Corporis iusto necessitatibus aut rerum eum. Voluptatem repellendus soluta doloremque. Et reiciendis et animi ut enim. Fugiat consequatur hic laborum culpa blanditiis explicabo nobis quae. Quae pariatur quo et hic autem.

Sunt velit eos repellat inventore quia sunt. Et optio aut distinctio non expedita nulla sint. Explicabo sint tempore est in sunt dolores et. Modi sint earum veniam perspiciatis. Velit at beatae nam fugiat iusto.

Sed velit ipsum in qui expedita praesentium. Neque vero optio qui cumque sint. Error possimus dolor quisquam vero aut.

Autem non labore numquam. Eveniet facere id qui impedit. Sunt temporibus sit neque fugiat. Consequatur sit maiores dolorum libero provident a laudantium. Ipsum sit fugiat quis consectetur sed a provident veritatis. Consequuntur laudantium aut libero facere animi ipsum et hic.


\newpage


## References

**Just the references of this chapter, that also needs to be included in the
final references.**

::: {#refs}
:::

