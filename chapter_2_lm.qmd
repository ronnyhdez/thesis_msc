---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Assesing uncertanties related to satellite remote sensing indices to estimate Gross Primary Production

## Introduction

Vegetation Gross Primary Production (GPP) is the total amount of carbon fixation by plants
through photosynthesis [@badgley_terrestrial_2019]. Quantifying GPP is essential
for understanding land-atmosphere carbon exchange [@kohler_global_2018],
ecosystem function, and ecosystem responses to climate change
[@guan_comparison_2022; @brown_fiducial_2021; @myneni_relationship_1994]. However,
terrestrial GPP cannot be directly estimated due to the contribution of 
respiration to land carbon fluxes [@anav_spatiotemporal_2015]. Instead, GPP is
only inferred by the net carbon exchange measurements at the ecosystem level,
or at broarder scales using models that incorporate variour assumptions and
limitations [@reichstein_separation_2005; @jung_towards_2009]. One widely used
approach to approximate and quantify GPP is the data driven models of spectral
vegetation indices [@ryu_what_2019] However, GPP estimation using spectral
vegetation indices remain with high uncertainties and validation efforts are 
required to characterize these and improve accuracy. [@anav_spatiotemporal_2015; @brown_fiducial_2021]

There are several methods to calculate GPP that can be grouped into two broad
categories: eddy covariance techniques, and satellite data-driven
[@guan_comparison_2022; @xie_assessments_2020] Eddy Covariance (EC) techniques
are methods that allowed scientists to directly measure the carbon, water, and
energy fluxes between vegetation canopies and the atmosphere since the 1990s
[@baldocchi_how_2020; @ryu_what_2019]. This method to measure terrestrial
fluxes, is the principal in-situ approach for quantifying the exchange of CO2 between
the land and atmosphere using advanced field instrumentation
[@badgley_terrestrial_2019; @tramontana_predicting_2016]. Measurements provided
using EC have a limited spatial resolution of less than \< 1km2 , which bring
spatial constraints to estimations of ecosystem carbon and water fluxes at
regional to global scales. [@badgley_canopy_2017].

The second category of methods to estimate GPP is the satellite data-driven
models. Because of their dependency on earth observation platforms, they are not
spatially constrained but can have more uncertainties than the EC techniques
[@ryu_what_2019; @wang_diagnosing_2011]. Satellite data-driven models can be
classified into Vegetation Index models (VI), Light Use Efficiency models (LUE),
and process-based models [@xie_assessments_2020].

LUE models are based on the concept of radiation conversion efficiency, and take
into consideration ecological processes [@liu1997process]. The radiation
conversion efficiency represents the amount of carbon that a specific type of
vegetation can fix per unit of solar radiation [@monteith_solar_1972]. The
Moderate Resolution Imaging Spectroradiometer (MODIS) GPP product uses an 
algorithm based on this radiation conversion efficiency concept, relating the
absorbed photosynthetically active radiation (APAR) with the LUE term [@heinsch_evaluation_2006] as shown in @eq-gpp .

$$
\small
GPP = PAR \times fAPAR \times LUE
$$ {#eq-gpp}

Where PAR is the incident photosynthetically active radiation and fAPAR is the
fraction of the PAR that is effectively absorbed by plants. fAPAR can be used to
assess the primary productivity of canopies [GCOS, 2011;
@running_continuous_2004]. LUE is the radiation use conversion efficiency term
of the vegetation [@heinsch_evaluation_2006]

VIs are a summary of non-linear functions of surface bi-directional reflectance
spectra [@myneni_relationship_1994] derived from optical sensors that are combined with
climate variables to calculate GPP [@wu_predicting_2011]. This is usually done
with some form of regression and physical methods that associate interactions
between vegetation and incoming radiation [@fernandez-martinez_monitoring_2019]

Well known VIâ€™s used to estimate GPP are normalized difference vegetation index
(NDVI), enhanced vegetation index (EVI), Near-Infrared Reflectance Index (NIRv)
and Chlorophyll/Carotenoid Index (CCI) among others.
[@balzarolo_influence_2019; @rahman_potential_2005; @rahman_potential_2005;
@xie_assessments_2020; @badgley_terrestrial_2019; @zhang_potential_2020;
@sellers_global_1994] These VIs are based on a spectral reflectance ratio 
between the red and near-infrared regions of the electromagnetic spectrum 
[@glenn_relationship_2008] which tracks an integrated impact of fraction of 
photosynthetically active radiation (fAPAR) and LUE on productivity.[@myneni_relationship_1994]

Nonetheless, even when estimating GPP from satellite remote sensing methods is
promising to overcome limitations as temporal and spatial scale, there are some
challenges involved in the process. The first constraint is the use of images
needed to address the problem of mixed-pixels, which requires determining the
fraction of the vegetated surface and its attributable signal
[@badgley_canopy_2017]. A second challenge is that photosynthesis regulation can
occur with no major changes in canopy structure or leaf pigments that can
undergo without being detected with reflectance data
[@pabon-moreno_potential_2022; @pierrat_diurnal_2022], and this could imply
that temporal aggregation may be critical for VI models.

The accuracy of GPP estimation through the use of VIs can be affected due to
their limitation to predict spatial, temporal, interannual variability and
trends. [@fernandez-martinez_monitoring_2019]. An index such as NDVI is good for
detecting changes in seasonal variability, but it becomes saturated with high
biomass conditions [@badgley_canopy_2017]. Other indices such as EVI can
overcome this problem and be better suited for predicting GPP in large biomass
forests [@badgley_canopy_2017] but it has been evaluated in a narrow range of
ecosystems and needs inputs of start and end dates of the growing seasons which
can increase uncertainties [@shi_assessing_2017].

To overcome these problems, other indices have been formulated in recent years.
One of these VIs is near-infrared reflectance index (NIRv)
[@badgley_terrestrial_2019] NIRv is defined as the fraction of reflected NIR
light that originates from vegetation. NIRv was originally proposed as a
replacement for fPAR in LUE models in that the NIR and PAR reflectance of
vegetation are correlated and the scaling by NDVI corrects for soil
contributions in the signal [@badgley_terrestrial_2019] NIRv has been shown to
have a stronger correlation to GPP at flux towers and on a regional basis than
fAPAR notwithstanding the fact that GPP is directly related to fAPAR. NIRv has been extended
to include a weighting with PAR [@dechant_nirvp_2022] and replacing the NIR
reflectance with NIRv radiance [@wu_radiance-based_2020]. Both of these
approaches have been shown to have even stronger correlations with GPP than NIRv
as could be expected since they either directly or indirectly weight the NIRv
with PAR.

The stronger correlation between the NIR indices to GPP versus indices based on
fAPAR seemingly contradicts the hypotheses in the LUE model that GPP should be
linearly related to fAPAR. There are two explanations: i. Many of the reported
comparative studies use fAPAR based on VIs and not APAR. We hypothesize that the
NIR indices are simply better estimators of APAR than these VI approximations
due to lower measurement error for the NIR indices or a stronger physical
relationship between them and APAR versus the historical VIs. ii. The strength of
correlation between APAR and GPP depends on LUE having a linear relationship to
observed APAR. While this may hold in some circumstances (e.g. early seasonal
measurements for vegetation such as crops where leaf chlorophyll concentration
increases during the growth phase) it is not the case in general and definitely
during stress conditions [@monteith_solar_1972].

Despite these efforts, relying solely on these remote satellite VIs presents 
a challenge. The assumptions  accompanying VI models suggest the importance of
systematically quantify their predictive capacity for GPP across various 
growing seasons and locations. Therefore, there is a demand to make efforts to 
validate and quantify their accuracy [@brown_fiducial_2021]. In-situ 
eddy-covariance flux measurements represent a solution given that they represent
site-level observations. With the calculation of the flux footprint, the area 
from the flux tower can serve as a reference point in which satellite images 
can be linked to a specific set of pixels and calculate the accuracy of the 
estimations provided by the indices [@chu_representativeness_2021].

As such, the main objective of my M.Sc. thesis is the analysis of uncertainty
associated with the VI/LUE models since they offer the potential for GPP
estimation without requiring knowledge regarding canopy and soil properties
other than measurements of reflected light and possibly a correction for soil
contribution. We aim to quantify the uncertainty from some of the most used
satellite vegetation indices with in-situ GPP data for multiple growing seasons
from the Bartlett Experimental Forest (USA), the Borden Forest Research Station
flux-site (Canada), and the University of Michigan Biological Station (USA).

\newpage

## Methods

```{r libraries and sources}
#| echo: false
#| message: false
#| warning: false

# Libraries
library(ggplot2)
library(cowplot)
library(lubridate)
library(purrr)
library(broom)
library(gt)
library(tidymodels)
library(broom)
library(usemodels)
library(vip)
library(h2o)
library(mgcv) 

# Source files
# Source the objects created for the complete GPP trends.
# This file will source the code and load objects to memory.
source("scripts/trend_plots.R")

# Source the objects created for the complete GPP trends
source("scripts/models_data_preparation.R")

# Source file with functions to plot rf predictions
source("R/plot_exploratory.R")
```

### Eddy Covariance sites

We used three deciduous broadleaf forest sites located in the northern 
hemisphere with eddy covariance (EC) data collected by Ameriflux. For each site,
we used the daily, weekly, and monthly GPP values (GPP_DT_VUT_REF variable) estimated
using the ONEFlux workflow [@pastorello2020fluxnet2015]. The ONEFlux 
processing does the estimation of the CO~2~ fluxes into GPP and Ecosystem 
Respiration (RECO) from Net Ecosystem Exchange (NEE) through two methods known
as daytime and nighttime. Here we selected the daytime method (DT) which uses
daytime and nighttime to parameterize a model with two components: one based on 
light response curve and vapour pressure deficit and a second one using a
respiration-temperature relationship to estimate RECO which in turn is used to
obtain the difference with NEE and provide GPP. [@pastorello2020fluxnet2015].

@fig-gpp_trends displays the GPP trends for the University of Michigan 
Biological Station, Bartlett experimental forest, and the Borden Forest 
Research Station. Additional details regarding the characteristics of these 
datasets can be found in Table @tbl-oneflux_datasets.

| Site     | Data range available | Dataset name                                                | Reference                  |
|-------------------|---------------------|---------------------|-------------------|
| Bartlett | Jan 2015 to Dec 2017 | US-Bar: Barlett Experimental Forest (version: beta-3)       | [@staebler2019ameriflux]   |
| Borden   | Jan 2015 to Jan 2022 | CA-Cbo: Ontario - Mixed Deciduous, Borden Forest Site       | [@richardson2016ameriflux] |
| Michigan | Jan 2015 to Jan 2018 | US-UMB: Univ. of Mich. Biological Station (version: beta-4) | [@gough2016ameriflux]      |

: ONEFlux sites datasets description {#tbl-oneflux_datasets}

The Bartlett experimental forest is located in New Hampshire, USA (44Â°06â€²N,
71Â°3â€²W). This site is characterized by a forest with an average canopy height 
ranging from 20 to 22 meters with a mean annual temperature of 6C. 
Despite events such as a hurricane in 1938 and small scale forest management,
the forest mean stand age is around 120-125 years. [@ouimette_carbon_2018]

The second flux site is Borden Forest Research Station located in Ontario
(44Â°19â€²N, 79Â°56â€²W), Canada. This is one of the largest patches of forest in
Southern Ontario which has been collecting EC data since 1996
[@rogers_response_2020]. This site has a forest cover of over 60% with a height
that exceeds 2 m. It's a deciduous broadleaf natural re-growth forest dominated
by woody vegetation. [@lee_long-term_1999].

The third site is the University of Michigan Biological Station which is located
in northern Michigan, USA (45Â°350 N 84Â°430 W). The site have a forest with
different succesional stages and a mean height of 2m. Mean annual temperature is
around 5.5Â°C. [@gough_disturbanceaccelerated_2021]

```{r}
#| label: fig-gpp_trends
#| fig-cap: "GPP trends from the study sites on a daily (a), weekly (b), and monthly (c) basis for the University of Michigan Biological Station, Bartlett experimental forest, and the Borden Forest Research Station"
#| fig-width: 11
#| fig-height: 12
#| echo: false
#| message: false
#| warning: false
gpp_trends
```


<!-- ```{r} -->
<!-- #| label: fig-michigan_gpp_trends -->
<!-- #| fig-cap: "GPP trends for Michigan" -->
<!-- #| fig-width: 7 -->
<!-- #| fig-height: 9 -->
<!-- #| echo: false -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- michigan_gpp_trends -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: fig-bartlett_gpp_trends -->
<!-- #| fig-cap: "GPP trends for Bartlett" -->
<!-- #| fig-width: 7 -->
<!-- #| fig-height: 9 -->
<!-- #| echo: false -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- bartlett_gpp_trends -->
<!-- ``` -->


<!-- ```{r} -->
<!-- #| label: fig-borden_gpp_trends -->
<!-- #| fig-cap: "GPP trends for Borden" -->
<!-- #| fig-width: 7 -->
<!-- #| fig-height: 9 -->
<!-- #| echo: false -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- borden_gpp_trends -->
<!-- ``` -->

<!-- The GPP for each of the sites can -->

<!-- -   include description of the ONEFlux processing (gap filling, data quality, -->
<!--     gpp estimation, gpp uncertainty with DT and NT) -->

### Satellite imagery

We used Google Earth Engine (GEE) to retrieve data from the Terra Moderate 
Resolution Imaging Spectroradiometer (MODIS), specifically the collection 
MOD09GA Version 6.1 product. A square polygon with an area of 3km surrounding 
the EC tower was defined for each site, and the complete data pixel values 
within this polygon was extracted for analysis.

The MODIS contains the surface spectral reflectance from bands to 1 through 7
with a spatial resolution of 500m, with corrections for atmospheric conditions 
such as aerosols, gasses and Rayleigh scattering [@vermote2021modis]. Bands used
to derived the vegetation indices are shown in @tbl-MODIS_500_indices_bands


| **Name**    | **Description** | **Resolution** | **Wavelength** |
|-------------|-----------------|----------------|----------------|
| sur_refl_01 | Red             | 500 meters     | 620-670nm      |
| sur_refl_02 | NIR             | 500 meters     | 841-876nm      |
| sur_refl_03 | Blue            | 500 meters     | 459-479nm      |
| sur_refl_04 | Green           | 500 meters     | 545-565nm      |

: MODIS (MOD09GA.061 product) bands used to calculate the VIs {#tbl-MODIS_500_indices_bands}

<!-- | Data                  | Spatial resolution (m) | GEE image collection         | -->
<!-- |-----------------------|------------------------|------------------------------| -->
<!-- | MODIS reflectance     | 500                    | MODIS/006/MOD09GA            | -->
<!-- | MODIS reflectance     | 250                    | MODIS/061/MOD09A1            | -->
<!-- | Harmonized Sentinel-2 | 20 - 60 - 10           | COPERNICUS/ S2_SR_HARMONIZED | -->

<!-- : Satellite images datasets {#tbl-satellite_images_datasets} -->

The data processing involved three main steps: selecting high-quality pixels,
scaling band values, and calculating vegetation indices. MODIS product data
have 4 bit-encoded variables which provided information about the observation 
quality. From those variables, only the `state_1km` and `qc_500m` variables were
used along with each of the bands bits quality indicators, as `q_scan` was not
informative and `g_flags` had the same value for all observations. The
bit-encoded variables were transformed into categorical strings, and only the
categories indicating the best quality were selected to filter the pixels (@fig-quality_pixels). The specific bit strings selected for `state_1km` are
shown in @tbl-state_1km_bitstrings and for `qc_500m` in @tbl-qc_scan_bit_strings.

In the second stage of the data processing, after selecting the highest
quality pixels, all the bands values were scaled. For each observation,
regardless of the specific band, a scaling factor of `0.0001` was applied. This
scaling factor was used to adjust the magnitude of the values and ensure
consistency in the data.

According to the documentation, any scaled value that fell outside the range of
`0` to `1` was considered a fill value or uncorrected Level 1B data and was
subsequently discarded. These values were deemed unreliable or lacking
meaningful information for the analysis. The complete selected high quality
pixels for the complete period per each of the sites is shown in @fig-complete_quality_pixels

Once all the band values were scaled within the valid range, the vegetation
indices such as `NDVI` (@eq-ndvi), `NIRv` (@eq-nirv), `EVI` (@eq-evi), and 
`CCI` (@eq-cci) were calculated and then matched with the corresponding date in 
the flux datasets. The resulting values used for the analysis are shown in
@fig-quality_pixels

<!-- However, since the -->
<!-- MODIS product with a spatial resolution of 250m (`MODIS/061/MOD09A1`) does not -->
<!-- include the blue band EVI calculations were not performed for this dataset. -->

\begingroup
\fontsize{10pt}{10pt}\selectfont
$$
\small
NDVI = \frac{NIR - Red}{NIR + Red}
$$ {#eq-ndvi}

$$
NIRv = NIR\times\frac{NIR - Red}{NIR + Red}
$$ {#eq-nirv}

$$
EVI = 2.5\times\frac{\mathrm{NIR} - \mathrm{Red}}{%
          (\mathrm{NIR} + 6\times \mathrm{Red}
          - 7.5\times \mathrm{Blue} + 1)}\\
$$ {#eq-evi}

<!-- $$ -->
<!-- kNDVI = tanh(\mathrm{NDVI}^2) -->
<!-- $$ {#eq-kndvi} -->

$$
CCI = \frac{Green - Red}{Green + Red}
$$ {#eq-cci}
\endgroup

<!-- For Harmonized Sentinel-2 data the data processing consisted on using the -->
<!-- `msk_cldprb` variable to filter out pixels according to the probabilities of -->
<!-- containing a cloud or the `msk_snwprb` variable for presence of snow -->
<!-- probability. Once the pixels without any probability of having clouds or snow -->
<!-- were filtered from the rest, we scaled all the reflectance bands observations by -->
<!-- a factor of `0.0001`. With the values scaled we proceed to calculate the -->
<!-- vegetation indices `NDVI` (@eq-ndvis), `NIRv` (@eq-nirvs), and `EVI` (@eq-evis). -->
<!-- The bands used to calculate these indices are in -->
<!-- @tbl-harmonized_s2_indices_bands -->

<!-- $$ -->
<!-- NDVI = \frac{b8 - b4}{b8 + b4} -->
<!-- $$ {#eq-ndvis} -->

<!-- $$ -->
<!-- NIRv = b8\times\frac{b8 - b4}{b8 + b4} -->
<!-- $$ {#eq-nirvs} -->

<!-- $$ -->
<!-- EVI = 2.5\times\frac{\mathrm{b8} - \mathrm{b4}}{% -->
<!--           (\mathrm{b8} + 6\times \mathrm{b4} -->
<!--           - 7.5\times \mathrm{b2} + 1)}\\ -->
<!-- $$ {#eq-evis} -->

```{r}
#| label: fig-complete_quality_pixels
#| fig-cap: "Total number of observations (pixels) from MODIS classified as high quality (used in the analysis) or other quality (filtered out from the analysis)"
#| echo: false
#| message: false
#| warning: false
source("scripts/quality_observations.R")

all %>%
  filter(quality == "high") %>%
  mutate(year_mon = zoo::as.yearmon(date)) %>%
  ggplot(aes(x = year_mon, fill = site)) +
  geom_bar(position = "stack") +
  scale_fill_viridis_d(begin = 0.2, end = 0.8) +
  labs(x = "Date",
       y = "Total observations (pixels)",
       fill = "Site") +
  theme_bw(base_size = 12)
```

### Data Preparation

In the study, three datasets were prepared for each site: a daily dataset, a
weekly dataset, and a monthly dataset. These datasets were generated from the
satellite imagery data with the selected high quality pixels and the
ONEFluxprocess data in order to capture variations in vegetation indices (VI),
band values, and GPP over different time scales.

The daily dataset included the VI values, band values only from the high quality
pixels, and GPP measurements derived from the ONEFlux process collected on a
daily basis. This dataset provided a high-resolution representation of the
variables, allowing for a detailed analysis of their daily fluctuations.

The weekly and monthly datasets were derived from the corresponding daily
dataset. These datasets contained summarized values of the VIs and band values,
aggregated over the weekly and monthly time frames, respectively. The
aggregation process involved calculating an average for the VIs and band values
within each week or month.

For the GPP values in the weekly and monthly datasets, rather than summarizing
the daily GPP values, the GPP measurements for the weekly and monthly time
frames were obtained directly from the ONEFlux process, which provided a
reliable estimation of GPP for these longer time intervals.

By creating these three datasets (daily, weekly, and monthly), the study allowed
for a comprehensive analysis of the VIs, band values, and GPP at different
temporal resolutions. This approach provided insights into the temporal dynamics
and patterns of the variables, enabling a more thorough understanding of the
processes and relationships under investigation.

For each site and across all time scales (daily, weekly, and monthly), we remove
GPP values that were less than 1 gC m^-2^ d^-1^ . By doing this, the study aimed
to exclude values that were potentially unreliable or insignificant in terms of
representing meaningful vegetation productivity. GPP values below this threshold
were considered to be either below the detection limit or not enough to 
contribute significantly to the overall analysis. Additionally, the removal of 
numerous zero GPP values was carried out to prevent undue exaggeration of 
regression goodness-of-fit metrics.

The final number of observations per site after selecting the high quality pixels
and GPP observations are shown in @fig-obs_used_analysis

```{r}
#| label: fig-quality_pixels
#| fig-cap: "Total number of observations (pixels) from MODIS classified as high quality (used in the analysis) or other quality (filtered out from the analysis) per site."
#| echo: false
#| message: false
#| warning: false
source("scripts/quality_observations.R")

all %>% 
  ggplot(aes(x = site, fill = quality)) +
  geom_bar(position = "stack") +
  scale_fill_viridis_d(begin = 0.34, end = 0.8) +
  labs(x = "Site", 
       y = "Total observations (pixels)",
       fill = "Quality") +
  theme_bw(base_size = 12)
```

```{r}
#| label: fig-obs_used_analysis
#| fig-cap: "Monthly distribution of high-quality MODIS observations after joining with flux observations containing Gross Primary Productivity (GPP) values higher than 1."
#| echo: false
#| message: false
#| warning: false

# Dataset used to analyze the data
daily_plot_500 %>% 
  # Dataset have all indices per row, so for the same date there are 5 obs
  filter(index == "ndvi_mean") %>% 
  group_by(site, date) %>% 
  tally() %>% 
  group_by(site) %>% 
  mutate(year_mon = zoo::as.yearmon(date)) %>% 
  ggplot(aes(x = year_mon, fill = site)) +
  geom_bar(position = "stack") +
  scale_fill_viridis_d(begin = 0.2, end = 0.8) +
  labs(x = "Date",
       y = "Total observations",
       fill = "Site") +
  theme_bw(base_size = 12) 

# daily_plot_500 %>% 
#   pivot_wider(names_from = index, values_from = value) %>% 
#   select(date, total_obs, site) %>% 
#   mutate(year_mon = zoo::as.yearmon(date)) %>% 
#   group_by(site, year_mon) %>% 
#   tally() %>% 
#   ungroup() %>% 
#   mutate(year_mon = as.factor(year_mon)) %>%
#   ggplot(aes(x = year_mon, y = n, fill = site)) +
#   geom_bar(stat = "identity", position = "stack") +
#   scale_fill_viridis_d(begin = 0.2, end = 0.8) +
#   labs(x = "Date",
#        y = "Total observations",
#        fill = "Site") +
#   theme_bw(base_size = 12) +
#   theme(axis.text.x = element_text(angle = 90, h = 1))
```

### Data Analysis

Two distinct modelling approaches were employed to estimate GPP by utilizing 
the calculated VIs: a linear model and a Generalized Additive Model (GAM). These
models were created to evaluate the performance of individual indices as well as
their collective performance, while simultaneously considering the effects of 
individual site characteristics and the aggregation of sites across various
temporal scales.

This facilitated a comparative analysis of how each individual index 
independently explains the variation in GPP per site. Additionally, with the 
uniform  nature of the three examined forest sites, an evaluation was performed 
to explore the GPP relationship without the distinction of the specific sites, 
considering each vegetation index individually. Another step of the analysis 
was the examination of the relationship between GPP and all indices functioning
as covariates, both on an individual site basis and without site distinction.

We applied the same methodology to the GAM models which allows a better fit for
those cases where the distribution and variability observed in the data is 
greater, due to the varying temporal scales. We aimed to evaluate if this 
variance could be better explained by this type of model, that might not be 
optimal to capture with a linear relationship, potentially leading to 
greater residuals. 

In total, per each site plus the category of all-sites we created 5 linear 
models and 5 GAM models for every timescale (daily, weekly, and monthly): one 
per each index (NDVI, CCI, EVI, NIRv) and one with all the indices as
covariates (NDVI + CCI + EVI + NIRv), resulting in a total of 120 models. To
compare the performance of the models we calculated the R squared (R2), the Root 
Mean Squared Error (RMSE), and the Mean Absolute Error (MAE)

```{r gpp_vi_realtions_all_sites}
#| label: fig-gpp_vi_relation_daily
#| fig-cap: "Scatterplot of MODIS 500m derived VIs and GPP with daily values. Every observation corresponds to the observed GPP from a flux tower site. Total observations corresponds to the number of observations used to obtain the mean of the vegetation index (NDVI, NIRv, CCI and EVI). The red line indicates the GAM fit."
#| fig-width: 7
#| fig-height: 5
#| echo: false
#| message: false
#| warning: false

## Make sure the source of file "scripts/trend_plots.R" was successful
etiquetas <- c(
  "evi_mean" = "EVI",
  "ndvi_mean" = "NDVI",
  "nirv_mean" = "NIRv",
  "kndvi_mean" = "kNDVI",
  "cci_mean" = "CCI",
  "Borden" = "Borden",
  "Michigan" = "Michigan",
  "Bartlett" = "Bartlett"
)

# daily_grid <-
  daily_plot_500 %>% 
  filter(index != "kndvi_mean") %>% 
  # filter(ndvi_mean > 3 & gpp_dt_vut_ref < 20)
  mutate(month = lubridate::month(date, label = TRUE)) %>% 
  ggplot(aes(x = value, y = gpp_dt_vut_ref)) +
  geom_point(aes(color = month, size = total_obs), alpha = 0.8) +
  geom_smooth(method = "gam", se = FALSE, color = "#E20D6A") +
  scale_color_viridis_d() + 
  scale_fill_viridis_d(aes(month)) +
  facet_grid(site~index, scales = "free", labeller = as_labeller(etiquetas)) +
  scale_size(range = c(.1, 5), name = "Total observations") +
  scale_x_continuous(breaks = seq(-1, 1, by = .1)) +
  scale_y_continuous(breaks = seq(0, 38, by = 4)) +
  labs(x = "Index value", 
       y = expression(GPP~(gC~m^{"-2"}~d^-1)),
       color = "Month") +
  theme_classic(base_size = 10) +
  theme(axis.text.x = element_text(angle = 60, h = 1)) +
  guides(size = guide_legend(order = 1, keyheight = 0.1),
         col = guide_legend(order = 2, keyheight = 0.1)) +
  theme(strip.text = element_text(size = 10, color = "black"),
        strip.background = element_blank())
```


```{r gpp_vi_realtions_all_sites}
#| label: fig-gpp_vi_relation_weekly
#| fig-cap: "Scatterplot of MODIS 500m derived VIs and GPP with weekly values. Every observation corresponds to the observed GPP from a flux tower site. Total observations corresponds to the number of observations used to obtain the mean of the vegetation index (NDVI, NIRv, CCI and EVI). The red line indicates the GAM fit."
#| fig-width: 7
#| fig-height: 5
#| echo: false
#| message: false
#| warning: false
# weekly_grid <-
  weekly_plot_500 %>% 
  filter(index != "kndvi_mean") %>% 
  mutate(month = lubridate::month(date_start, label = TRUE)) %>% 
  ggplot(aes(x = value, y = gpp_dt_vut_ref)) +
  geom_point(aes(color = month, size = total_obs), alpha = 0.8) +
  geom_smooth(method = "gam", se = FALSE, color = "#E20D6A") +
  scale_color_viridis_d() + 
  scale_fill_viridis_d(aes(month)) +
  facet_grid(site~index, scales = "free", labeller = as_labeller(etiquetas)) +
  scale_size(range = c(.1, 5), name = "Total observations") +
  scale_x_continuous(breaks = seq(-1, 1, by = .1)) +
  scale_y_continuous(breaks = seq(0, 38, by = 4)) +
  labs(x = "Index value", 
       y = expression(GPP~(gC~m^{"-2"}~d^-1)),
       color = "Month") +
  theme_classic(base_size = 10) +
  theme(axis.text.x = element_text(angle = 60, h = 1)) +
  guides(size = guide_legend(order = 1, keyheight = 0.1),
         col = guide_legend(order = 2, keyheight = 0.1)) +
  theme(strip.text = element_text(size = 10, color = "black"),
        strip.background = element_blank())
```


```{r gpp_vi_realtions_all_sites}
#| label: fig-gpp_vi_relation_monthly
#| fig-cap: "Scatterplot of MODIS 500m derived VIs and GPP with monthly values. Every observation corresponds to the observed GPP from a flux tower site. Total observations corresponds to the number of observations used to obtain the mean of the vegetation index (NDVI, NIRv, CCI and EVI). The red line indicates the GAM fit."
#| fig-width: 7
#| fig-height: 5
#| echo: false
#| message: false
#| warning: false

# monthly_grid <-
  monthly_plot_500 %>% 
  filter(index != "kndvi_mean") %>% 
  mutate(month = lubridate::month(date, label = TRUE)) %>% 
  ggplot(aes(x = value, y = gpp_dt_vut_ref)) +
  geom_point(aes(color = month, size = total_obs), alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE, color = "#E20D6A") +
  scale_color_viridis_d() + 
  scale_fill_viridis_d(aes(month)) +
  facet_grid(site~index, scales = "free", labeller = as_labeller(etiquetas)) +
  scale_size(range = c(.1, 5), name = "Total observations") +
  scale_x_continuous(breaks = seq(-1, 1, by = .1)) +
  scale_y_continuous(breaks = seq(0, 18, by = 4)) +
  labs(x = "Index value", 
       y = expression(GPP~(gC~m^{"-2"}~d^-1)),
       color = "Month") +
  theme_classic(base_size = 10) +
  theme(axis.text.x = element_text(angle = 60, h = 1)) +
  guides(size = guide_legend(order = 1, keyheight = 0.1),
         col = guide_legend(order = 2, keyheight = 0.1)) +
  theme(strip.text = element_text(size = 10, color = "black"),
        strip.background = element_blank())

# plot_grid(daily_grid,
#           weekly_grid,
#           monthly_grid,
#           nrow = 3,
#           labels = c('A', 'B', 'C'))
```

\newpage

## Results

### Analysis of GPP-Vegetation Index Relationships Using Linear Models
<!-- ### Monthly GPP and VIs relations -->


Monthly:

 - When using all indices as covariates, for the three sites and including the
 3 sites without distinction, the model predicts better.
 - When comparing individual indices, CCI is a better predictor compared to the 
 other indices, although in the case of Bartlett and Michigan, the performance
 is not that substantial when compared with NIRv and EVI. In the case Borden and
 all sites, it does a better job.
 - NDVI performs less favourably in Bartlett by 9% and Michigan by 15% when 
 compared with CCI.
 - For Borden and all sites together EVI performed less favourably than the
 other indices, although in the case of Borden, the performance is not that
 different from the other indices.
 - Bartlett have the best performant results, while all sites together the
 worst. 
 
Weekly:

 - Using all indices as covariates, for every site individually and considering
 all the sites without distinction, the model predicts better.
 - NDVI performed worst in the 3 sites individually, and EVI the worst for 
 all  the sites as just one.
 - EVI performed lesss favourably in all sites without distinction, although
 the differences with the performance with individual indices such as NDVI and
 NIRv are not big.
 - EVI was better predicting GPP for Bartlett without almost no difference in
 the performance with CCI (RMSE was the only metric with a difference of 0.02)
 - Borden was the site with the worst performing models as individual site, but
 when all site combined, models performed worst.
 - Bartlett and Michigan as individual sites, had the best performing models.
 
Daily:

 - CCI performed better in 3 cases: for Bartlett, Borden and all sites, although
 Borden was better by 1%.
 - EVI performed better as an individual index, for Michigan with a differences
 of 3% compared with the next best performant individual index.
 - In all cases, using all indices as covariates helped with the model performance
 - Bartlett and Michigan had in general the best performant models.
 - Borden had the worst performant models in all cases. 
 
General:

 - In just one case, NIRv was the best predictor for GPP when using individual
 indices. (weekly and it was just because the RMSE of 0.02 diff)
 - CCI in general for all timeframes was the best predictor for GPP when
 using individual indices.
 - In the case of linear models, when using all indices as covariates, the 
 model performs better as opose when using just the individual indices.

The @tbl-lm_monthly_results provides a summary of linear models used for GPP 
estimation at each site, employing the vegetation indices as predictors. For 
each site and predictor, the table includes the relevant model summary 
statistics, such as R2, MAE, and RMSE. More metrics such as the 
p-value, adjusted r-squared, the Akaike Information Criterion (AIC), and 
Bayesian Information Criterion (BIC) are dispalyed in the @tbl-complete_lm_monthly_results

Based on the RMSE, NDVI performed less favourably  on 
two out of the three sites compared with the other indices. However, the 
performance difference among the sites was not substantial, with the Bartlett
experimental forest exhibiting slightly better results on all of their GPP ~ VIs
relations compared to the other sites. These findings suggest that while 
NDVI may not be the optimal vegetation index for GPP estimation at these sites,
there may still be variations in performance across different locations.

When using all the indices as covariates within the linear model, the model's 
performance demonstrates better outcomes compared to using any single index alone

The complete metrics results for each of the linear models are in
@tbl-complete_lm_monthly_results

\begingroup
\setlength{\LTleft}{0pt minus 500pt}
\setlength{\LTright}{0pt minus 500pt}
\fontsize{5pt}{7pt}\selectfont
\addtolength{\tabcolsep}{-3pt}

```{r lm_monthly}
#| label: tbl-lm_monthly_results
#| tbl-cap: "Summary of Linear models for GPP estimation using the vegetation indices on a monthly (a), weekly (b), and daily (c) basis."
#| tbl-colwidths: [50,50]
#| echo: false
#| message: false
#| warning: false
source("scripts/lm_preparation.R")

create_metrics_table <- function(data) {
  data %>% 
    gt() %>%
    tab_spanner(label = md("NDVI"), columns = ends_with("NDVI")) %>%
    tab_spanner(label = "EVI", columns = ends_with("EVI")) %>%
    tab_spanner(label = "NIRv", columns = ends_with("NIRv")) %>%
    tab_spanner(label = "CCI", columns = ends_with("CCI")) %>% 
    tab_spanner(label = "All", columns = ends_with("All")) %>% 
    cols_label(
      .list = list(
        "site" = "Site",
        "r.squared_EVI" = "R2",
        "mae_EVI" = "MAE",
        "rmse_EVI" = "RMSE",
        "r.squared_NDVI" = "R2",
        "mae_NDVI" = "MAE",
        "rmse_NDVI" = "RMSE",
        "r.squared_NIRv" = "R2",
        "mae_NIRv" = "MAE",
        "rmse_NIRv" = "RMSE",
        "r.squared_CCI" = "R2",
        "mae_CCI" = "MAE",
        "rmse_CCI" = "RMSE",
        "r.squared_All" = "R2",
        "mae_All" = "MAE",
        "rmse_All" = "RMSE"
      )
    ) %>% 
    cols_align(
      align = "center",
      columns = 2:16
    ) %>% 
    fmt_number(
      columns = 2:16,
      decimals = 2) %>% 
    tab_options(
      row_group.background.color = "#E9E0E1",
      row_group.font.weight = "bold"
    ) %>% 
    cols_width(everything() ~ px(50))
}

# Monthly table
vis_site_glance_monthly %>% 
  select(site, index, r.squared, mae, rmse) %>%
  bind_rows(all_sites_glance_monthly,
            all_sites_all_vis_glance_monthly,
            all_vis_glance_monthly) %>% 
  pivot_wider(names_from = index, 
              values_from = c(r.squared, mae, rmse)) %>%
  create_metrics_table()


# Weekly table
vis_site_glance_weekly  %>%
  select(site, index, r.squared, mae, rmse) %>%
  bind_rows(all_sites_glance_weekly,
            all_sites_all_vis_glance_weekly,
            all_vis_glance_weekly) %>% 
  pivot_wider(names_from = index, 
              values_from = c(r.squared, mae, rmse)) %>%
  create_metrics_table()

# Daily table
vis_site_glance_daily %>%
  select(site, index, r.squared, mae, rmse) %>%
  bind_rows(all_sites_glance_daily,
            all_sites_all_vis_glance_daily,
            all_vis_glance_daily)  %>% 
  pivot_wider(names_from = index, 
              values_from = c(r.squared, mae, rmse)) %>%
  create_metrics_table()
```

\endgroup


```{r lm_barplot_metrics}
#| label: fig-lm_metrics
#| fig-cap: "Summary of Linear models for GPP estimation using the vegetation indices on a monthly (a), weekly (b), and daily (c) basis."
#| fig-width: 7
#| fig-height: 9
#| echo: false
#| message: false
#| warning: false
library(cowplot)

# Create a function to generate the plot
create_metrics_plot <- function(timescale, y_var, ylim_range) {
  get(paste0("vis_site_glance_", timescale)) %>% 
    select(site, index, {{ y_var }}) %>%
    bind_rows(get(paste0("all_sites_glance_", timescale)),
               get(paste0("all_sites_all_vis_glance_", timescale)),
              get(paste0("all_vis_glance_", timescale))) %>% 
    ggplot(aes(x = site, y = .data[[y_var]], fill = index)) +
    geom_col(position = "dodge") +
    coord_cartesian(ylim = ylim_range) +
    scale_fill_viridis_d() +
    labs(x = "") +
    theme_minimal_hgrid(font_size = 12) +
    theme(axis.text.x = element_text(angle = 45, h = 1))
}

# Response variables are going to be the same:
response_vars <- c("r.squared", "mae", "rmse")

# Monthly plots
monthly_metrics_plots <- map2(response_vars, 
     list(c(0.3, 1), c(0.5, 4), c(0.5, 5)), 
     ~ create_metrics_plot("monthly", .x, .y))

# Weekly plots
weekly_metrics_plots <- map2(response_vars, 
              list(c(0.3, 1), c(0.5, 4), c(0.5, 5)),
              ~ create_metrics_plot("weekly", .x, .y))

# Daily plots
daily_metrics_plots <- map2(response_vars, 
              list(c(0.3, 1), c(0.5, 4), c(0.5, 5)),
              ~ create_metrics_plot("daily", .x, .y))

# Grid the plots as should go in the chapter
lm_metrics_plots <- plot_grid(
  monthly_metrics_plots[[1]] + theme(legend.position = "none"),
  weekly_metrics_plots[[1]] + theme(legend.position = "none"),
  daily_metrics_plots[[1]] + theme(legend.position = "none"),
  monthly_metrics_plots[[2]] + theme(legend.position = "none"),
  weekly_metrics_plots[[2]] + theme(legend.position = "none"),
  daily_metrics_plots[[2]] + theme(legend.position = "none"),
  monthly_metrics_plots[[3]] + theme(legend.position = "none"),
  weekly_metrics_plots[[3]] + theme(legend.position = "none"),
  daily_metrics_plots[[3]] + theme(legend.position = "none"),
  nrow = 3,
  ncol = 3,
  labels = c("A", "B", "C"))

plot_legend <- get_legend(
  monthly_metrics_plots[[1]] + 
    guides(color = guide_legend(nrow = 3)) 
)

plot_grid(lm_metrics_plots, plot_legend, ncol = 2, rel_widths = c(1, .1))
rm(plot_legend)
```


### Analysis of GPP-Vegetation Index Relationships Using GAM Models

Monthly

 - There is no unique index that performs better than the other ones. In the
 monthly case, CCI performed better for all sites without distinction, EVI
 performed better for Michigan, and all the indices as covariates for Borden.
 - Although for Borden, the performance of all indices as covariates was better
 than CCI alone by just 0.06 on the RMSE and 0.08 in MAE.
 - In the case of Michigan EVI and NIRv were able to explain 96% of the 
 variation, nonetheless EVI had slightly lower values of MAE and RMSE
 (0.01 and 0.02 respectively)
 - For Michigan and Borden, a GAM model with all the indices as covariates was
 not possible given the quantity of observations was low for the parameters
 included in the model, which could lead to overfitting.
 - NDVI alone performed worst in two sites, while EVI in just one.

Weekly:

 - Models that included all indices as covariates performed better that any
 of the indices alone in every individual site as well when using no site
 distinction.
 - In the case of all sites without distinction, all indices as covariates
 can explain 7% more thant CCI which is the best index alone. For Michigan, this
 increase was of 2% in comparison with EVI, Bartlett 1% in comparison with EVI,
 and 2% in Borden when contrasted with EVI.
 - NDVI as an index alone, performed less favourably when compared to the other
 indices alone. For all sites performed 7% less than CCI, in the case of 
 Michigan it was 17% less (EVI), Bartlett 18% less, and Borden 9%
 
Daily:

 - 




This variance implied that a linear 
relationship might not be optimal, potentially leading to substantial residuals.
In contrast, the GAM model was found to adeptly accommodate such variability and
provide a more comprehensive  explanation for the relationship. This adaptability was especially significant when addressing GPP's daily, weekly, or monthly variations.

<!-- ### Daily and weekly GPP and VIs relations -->

<!-- **TODO: Single vs Individual GAM model** -->

<!-- *This is a section under construction. Several models are presented in order -->
<!-- to discuss which one will be better to describe the patterns found* -->

<!-- Richard's suggestion is to create a single model using all indices as covariates. -->
<!-- The notes are described also in the issue [Ref #49](https://github.com/ronnyhdez/thesis_msc/issues/49) -->

<!-- **Single model** -->

<!--  - Using all the indices that I have as multiple predictors will allow me to  -->
<!--  explore the relation between GPP and each VI while also considering potential -->
<!--  interactions. But this will be an examination of the combined effects of the  -->
<!--  VIs on GPP and determine their relative importance. -->

<!-- **Individual model** -->

<!--  - A separate GAM model for each VI will allow me to explore the relation  -->
<!--  between GPP and each VI separately, without the exploration of potential  -->
<!--  interactions between the VIs.  -->

<!--  - But, do I want to explore if there are interactions? If there is an  -->
<!--  interaction, what would be the meaning of an interaction between indices? -->

<!--  - With the individual GAM models, I think that I can uncover individual trends, that otherwise would be hidden among all the VIs. [**simpson's paradox**](https://en.wikipedia.org/wiki/Simpson%27s_paradox) -->

\begingroup
\setlength{\LTleft}{0pt minus 500pt}
\setlength{\LTright}{0pt minus 500pt}
\fontsize{5pt}{7pt}\selectfont
\addtolength{\tabcolsep}{-3pt}
```{r}
#| label: tbl-gam_model_results_pvalue
#| tbl-cap: "Table 2.3: Summary of GAM models for GPP estimation using the vegetation indices on a monthly (a), weekly (b), and daily (c) basis." 
#| echo: false
#| message: false
#| warning: false
source("scripts/gam_preparation.R")

create_metrics_table <- function(data) {
  data %>% 
    pivot_wider(names_from = index,
                values_from = c(rsq, mae, rmse)) %>% 
    gt() %>%
    tab_spanner(label = md("NDVI"), columns = contains("NDVI")) %>%
    tab_spanner(label = "EVI", columns = contains("EVI")) %>%
    tab_spanner(label = "NIRv", columns = contains("NIRv")) %>%
    tab_spanner(label = "CCI", columns = contains("CCI")) %>% 
    tab_spanner(label = "All", columns = contains("All")) %>% 
    cols_label(
      .list = list(
        "site" = "Site",
        "rsq_evi_mean" = "R2",
        "mae_evi_mean" = "MAE",
        "rmse_evi_mean" = "RMSE",
        "rsq_ndvi_mean" = "R2",
        "mae_ndvi_mean" = "MAE",
        "rmse_ndvi_mean" = "RMSE",
        "rsq_nirv_mean" = "R2",
        "mae_nirv_mean" = "MAE",
        "rmse_nirv_mean" = "RMSE",
        "rsq_cci_mean" = "R2",
        "mae_cci_mean" = "MAE",
        "rmse_cci_mean" = "RMSE",
        "rsq_All" = "R2",
        "mae_All" = "MAE",
        "rmse_All" = "RMSE"
      )
    ) %>% 
    cols_align(
      align = "center",
      columns = 2:16
    ) %>% 
    fmt_number(
      columns = 2:16,
      decimals = 2) %>% 
    tab_options(
      row_group.background.color = "#E9E0E1",
      row_group.font.weight = "bold"
    ) %>% 
    cols_width(everything() ~ px(50)) 
}

# Monthly table
all_sites_gam_monthly %>% 
  bind_rows(vis_sites_gam_monthly,
            all_sites_all_vis_gam_monthly,
            all_vis_gam_monthly,
  ) %>% 
  create_metrics_table()

# Weekly table
all_sites_gam_weekly %>% 
  bind_rows(vis_sites_gam_weekly,
            all_sites_all_vis_gam_weekly,
            all_vis_gam_weekly,
  ) %>% 
  create_metrics_table()

# Daily table
all_sites_gam_daily %>% 
  bind_rows(vis_sites_gam_daily,
            all_sites_all_vis_gam_daily,
            all_vis_gam_daily,
  ) %>% 
  create_metrics_table()
```
\endgroup

```{r gam_barplot_metrics}
#| label: fig-gam_metrics
#| fig-cap: "Summary of GAM models for GPP estimation using the vegetation indices. Column A represents the metrics for the monthly models, B the weekly, and C the daily metrics."
#| fig-width: 7
#| fig-height: 9
#| echo: false
#| message: false
#| warning: false

# Create a function to generate the plot
create_metrics_plot <- function(timescale, y_var, ylim_range) {
  get(paste0("all_sites_gam_", timescale)) %>% 
    # select(site, index, {{ y_var }}) %>%
    bind_rows(get(paste0("vis_sites_gam_", timescale)),
              get(paste0("all_sites_all_vis_gam_", timescale)),
              get(paste0("all_vis_gam_", timescale))) %>% 
    ggplot(aes(x = site, y = .data[[y_var]], fill = index)) +
    geom_col(position = "dodge") +
    coord_cartesian(ylim = ylim_range) +
    scale_fill_viridis_d() +
    labs(x = "") +
    theme_minimal_hgrid(font_size = 12) +
    theme(axis.text.x = element_text(angle = 45, h = 1))
}

# Response variables are going to be the same:
response_vars <- c("rsq", "mae", "rmse")

# Monthly plots
monthly_metrics_plots <- map2(response_vars, 
     list(c(0.3, 1), c(0.5, 4), c(0.8, 5)), 
     ~ create_metrics_plot("monthly", .x, .y))

# Weekly plots
weekly_metrics_plots <- map2(response_vars, 
              list(c(0.3, 1), c(0.5, 4), c(0.8, 5)),
              ~ create_metrics_plot("weekly", .x, .y))

# Daily plots
daily_metrics_plots <- map2(response_vars, 
              list(c(0.3, 1), c(0.5, 4), c(0.8, 5)),
              ~ create_metrics_plot("daily", .x, .y))

# Grid the plots as should go in the chapter
gam_metrics_plots <- plot_grid(
  monthly_metrics_plots[[1]] + theme(legend.position = "none"),
  weekly_metrics_plots[[1]] + theme(legend.position = "none"),
  daily_metrics_plots[[1]] + theme(legend.position = "none"),
  monthly_metrics_plots[[2]] + theme(legend.position = "none"),
  weekly_metrics_plots[[2]] + theme(legend.position = "none"),
  daily_metrics_plots[[2]] + theme(legend.position = "none"),
  monthly_metrics_plots[[3]] + theme(legend.position = "none"),
  weekly_metrics_plots[[3]] + theme(legend.position = "none"),
  daily_metrics_plots[[3]] + theme(legend.position = "none"),
  nrow = 3,
  ncol = 3,
  labels = c("A", "B", "C"))

plot_legend <- get_legend(
  monthly_metrics_plots[[1]] + 
    guides(color = guide_legend(nrow = 3)) 
)

plot_grid(gam_metrics_plots, plot_legend, ncol = 2, rel_widths = c(1, .1))
rm(plot_legend)
```





\newpage

## Discussion




\newpage


## References

**Just the references of this chapter, that also needs to be included in the
final references.**

::: {#refs}
:::

